<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Καταχώριση Σημείου Hayati</title>

  <!-- Tailwind CSS + custom colors -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: {
        colors: {
          primary: '#1E3A8A',
          accent:  '#FBBF24',
          danger:  '#DC2626',
          success: '#16A34A'
        }
      }}
    }
  </script>
  <style>
    /* Ripple effect */
    .ripple { position: relative; overflow: hidden; }
    .ripple:after {
      content: "";
      position: absolute; width: 100%; height: 100%;
      top: 0; left: 0;
      background: radial-gradient(circle, rgba(255,255,255,0.5) 10%, transparent 10.01%);
      background-repeat: no-repeat; background-position: center;
      transform: scale(10); opacity: 0;
      transition: transform .5s, opacity 1s;
    }
    .ripple:active:after {
      transform: scale(0); opacity: .3; transition: 0s;
    }
  </style>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // Firebase init
    const firebaseConfig = {
      apiKey:    "AIzaSyDe966NdE-AW_eZrDCEKjw8y2h5mSdHr6o",
      authDomain:"pointregistrationapp.firebaseapp.com",
      projectId: "pointregistrationapp",
      storageBucket:"pointregistrationapp.firebasestorage.app",
      messagingSenderId:"925139386507",
      appId:     "1:925139386507:web:588ae991f39a7bab04548e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function daysSince(ts) {
      if (!ts) return Infinity;
      const d = ts.toDate(), now = new Date();
      return (now - d)/(1000*60*60*24);
    }

    document.addEventListener("DOMContentLoaded", () => {
      let userLat, userLng, allPoints = [], editId = null, selectionMode = false;

      // Refs
      const openBtn     = document.getElementById("openModalBtn"),
            addModal    = document.getElementById("modal"),
            cancelBtn   = document.getElementById("cancelBtn"),
            form        = document.getElementById("pointForm"),
            editModal   = document.getElementById("editModal"),
            editCancel  = document.getElementById("editCancel"),
            editForm    = document.getElementById("editForm"),
            routeModal  = document.getElementById("routeModal"),
            routeCancel = document.getElementById("routeCancel"),
            routeForm   = document.getElementById("routeForm"),
            routeRegion = document.getElementById("routeRegion"),
            routeDays   = document.getElementById("routeDays"),
            routeCount  = document.getElementById("routeCount"),
            container   = document.getElementById("pointsContainer"),
            regionF     = document.getElementById("regionFilter"),
            visitedF    = document.getElementById("visitedFilter"),
            routeBtn    = document.getElementById("routeBtn"),
            customBtn   = document.getElementById("customRouteBtn"),
            genBtn      = document.getElementById("generateCustomRouteBtn"),
            cancelGen   = document.getElementById("cancelCustomBtn");

      // Add-point modal
      openBtn.onclick = () => {
        if (!navigator.geolocation) { alert("Δεν υποστηρίζεται γεωεντοπισμός."); return; }
        navigator.geolocation.getCurrentPosition(pos => {
          userLat = pos.coords.latitude; userLng = pos.coords.longitude;
          addModal.classList.remove("opacity-0","pointer-events-none");
        }, ()=> alert("Άδεια τοποθεσίας απαραίτητη."));
      };
      cancelBtn.onclick = () => {
        addModal.classList.add("opacity-0","pointer-events-none");
        form.reset();
      };
      form.onsubmit = async e => {
        e.preventDefault();
        const name = form.pointName.value.trim(), area = form.areaSelect.value;
        if (!name||!area) { alert("Συμπληρώστε όλα τα πεδία."); return; }
        await db.collection("points").add({
          name, area,
          latitude: userLat, longitude: userLng,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        cancelBtn.click();
      };

      // Edit modal
      editCancel.onclick = () => {
        editModal.classList.add("opacity-0","pointer-events-none");
        editForm.reset();
      };
      editForm.onsubmit = async e => {
        e.preventDefault();
        const name = editForm.editName.value.trim(), area = editForm.editArea.value;
        if (!name||!area) { alert("Συμπληρώστε όλα τα πεδία."); return; }
        await db.collection("points").doc(editId).update({ name, area });
        editCancel.click();
      };

      // Route modal
      routeBtn.onclick = () => {
        routeModal.classList.remove("opacity-0","pointer-events-none");
        updateRouteCount();
      };
      routeCancel.onclick = () => {
        routeModal.classList.add("opacity-0","pointer-events-none");
        routeForm.reset(); routeCount.textContent="";
      };
      routeRegion.onchange = updateRouteCount;
      routeDays.onchange   = updateRouteCount;
      routeForm.onsubmit = e => {
        e.preventDefault();
        const sel = routeRegion.value, daysOpt = routeDays.value;
        if (!sel) { alert("Επιλέξτε περιοχή."); return; }
        let pts = allPoints.filter(p=> sel==='all'||p.area===sel);
        pts = pts.filter(p=>{
          const age = daysSince(p.lastVisit);
          switch(daysOpt){
            case 'lt3':   return age<3;
            case '3to7':  return age>=3&&age<=7;
            case 'gt7':   return age>7;
            case 'never': return !p.lastVisit;
            default:      return true;
          }
        });
        if (pts.length<2) { alert("Δεν υπάρχουν αρκετά σημεία."); return; }
        pts.sort((a,b)=>a.timestamp.seconds-b.timestamp.seconds);
        const coords    = pts.map(p=>`${p.latitude},${p.longitude}`),
              origin    = coords.shift(),
              dest      = coords.pop(),
              waypoints = coords.join("|");
        let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}`;
        if (waypoints) url += `&waypoints=${waypoints}`;
        window.open(url,"_blank");
        routeCancel.click();
      };
      function updateRouteCount(){
        const sel=routeRegion.value, daysOpt=routeDays.value;
        if (!sel) { routeCount.textContent=""; return; }
        let pts = allPoints.filter(p=> sel==='all'||p.area===sel);
        pts = pts.filter(p=>{
          const age = daysSince(p.lastVisit);
          switch(daysOpt){
            case 'lt3':   return age<3;
            case '3to7':  return age>=3&&age<=7;
            case 'gt7':   return age>7;
            case 'never': return !p.lastVisit;
            default:      return true;
          }
        });
        routeCount.textContent = `Βρέθηκαν ${pts.length} σημεία`;
      }

      // Custom route mode
      customBtn.onclick = () => {
        selectionMode = true;
        genBtn.classList.remove("hidden");
        cancelGen.classList.remove("hidden");
        render();
      };
      cancelGen.onclick = e => {
        e.stopPropagation();
        selectionMode = false;
        genBtn.classList.add("hidden");
        cancelGen.classList.add("hidden");
        render();
      };
      genBtn.onclick = () => {
        const checked = container.querySelectorAll("input[type=checkbox]:checked");
        if (!checked.length) { alert("Επιλέξτε σημεία."); return; }
        const coords = [...checked].map(cb=>{
          const p = allPoints.find(x=>x.id===cb.dataset.id);
          return `${p.latitude},${p.longitude}`;
        });
        const origin      = coords.shift(),
              destination = coords.pop(),
              waypoints   = coords.join("|");
        let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;
        if (waypoints) url += `&waypoints=${waypoints}`;
        window.open(url,"_blank");
        cancelGen.click();
      };

      // Firestore listener
      db.collection("points").orderBy("timestamp","desc")
        .onSnapshot(snap => {
          allPoints = snap.docs.map(d=>({ id:d.id, ...d.data() }));
          render();
        });

      // Filters
      regionF.onchange  = render;
      visitedF.onchange = render;

      function render(){
        container.innerHTML = "";
        const sel = regionF.value, vis = visitedF.value;
        allPoints.forEach(pt=>{
          const visited = !!pt.lastVisit;
          const okArea = !sel||pt.area===sel;
          const okVis  = vis==='all'||(vis==='visited'&&visited)||(vis==='unvisited'&&!visited);
          if(okArea&&okVis) container.appendChild(makeCard(pt));
        });
      }

      function makeCard(pt){
        const c = document.createElement("div");
        c.className = "relative bg-white/30 backdrop-blur-md ring-1 ring-white/20 p-6 rounded-2xl shadow-xl hover:scale-105 transform transition";

        // Checkbox
        if(selectionMode){
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.className = "absolute top-3 right-3 form-checkbox h-5 w-5 text-primary";
          cb.dataset.id = pt.id;
          c.append(cb);
        }
        // Region badge
        const badge = document.createElement("div");
        badge.className = "absolute -top-2 left-6 bg-primary text-white px-3 py-1 rounded-full text-xs uppercase";
        badge.textContent = pt.area;
        c.append(badge);

        // Header
        const h = document.createElement("div");
        h.className = "flex items-center gap-4 mb-4";

        const age = daysSince(pt.lastVisit);
        let dotClass = (age===Infinity||age>7) ? "bg-danger animate-pulse"
                        : (age>3)          ? "bg-accent animate-ping"
                                           : "bg-success";
        const dot = document.createElement("span");
        dot.className = `w-3 h-3 ${dotClass} rounded-full`;

        const lbl = document.createElement("span");
        lbl.className = "text-sm text-white/80 uppercase";
        lbl.textContent = (age===Infinity) ? "Ποτέ"
                           : (Math.floor(age)===1 ? "1 ημέρα" : `${Math.floor(age)} ημέρες`);

        const title = document.createElement("h3");
        title.className = "text-2xl font-bold uppercase text-white flex-1";
        title.textContent = pt.name;

        h.append(dot, lbl, title);
        c.append(h);

        // Buttons
        const btns = document.createElement("div");
        btns.className = "flex flex-wrap gap-3 mb-4";

        // Επίσκεψη
        const visitBtn = document.createElement("button");
        visitBtn.className = "ripple flex items-center gap-2 bg-yellow-400 text-white px-4 py-2 rounded-full uppercase shadow hover:scale-105 transform transition";
        visitBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>Επίσκεψη`;
        btns.append(visitBtn);

        // Αλλαγή
        const editBtn = document.createElement("button");
        editBtn.className = "ripple flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-full uppercase shadow hover:scale-105 transform transition";
        editBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16"/>
          </svg>Αλλαγή`;
        btns.append(editBtn);

        // Διαγραφή
        const delBtn = document.createElement("button");
        delBtn.className = "ripple flex items-center gap-2 bg-danger text-white px-4 py-2 rounded-full uppercase shadow hover:scale-105 transform transition";
        delBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>Διαγραφή`;
        btns.append(delBtn);

        c.append(btns);

        // Map link
        const mapLink = document.createElement("a");
        mapLink.className = "ripple block text-center bg-gradient-to-r from-primary to-accent text-white py-3 rounded-full uppercase font-bold shadow hover:scale-105 transform transition";
        mapLink.textContent = "Δείτε στον Χάρτη";
        c.append(mapLink);

        return c;
      }
    });
  </script>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center py-12">
  <!-- Header -->
  <header class="w-full bg-gradient-to-r from-primary to-accent text-white py-6 mb-8 drop-shadow-lg">
    <div class="max-w-3xl mx-auto px-4">
      <h1 class="text-4xl font-extrabold uppercase tracking-wider">Καταχώριση Σημείου</h1>
    </div>
  </header>

  <main class="w-full max-w-3xl px-4 space-y-6 mb-12">
    <!-- Actions -->
    <div class="flex flex-wrap gap-4 justify-center">
      <button id="routeBtn" class="ripple bg-success text-white px-6 py-2 rounded-full uppercase font-semibold shadow hover:scale-105 transform transition">Δρομολόγιο Περιοχής</button>
      <button id="customRouteBtn" class="ripple bg-success text-white px-6 py-2 rounded-full uppercase font-semibold shadow hover:scale-105 transform transition">Κάνε το Δικό Σου Δρομολόγιο</button>
    </div>
    <!-- Filters -->
    <div class="flex flex-col sm:flex-row gap-4 justify-between items-center">
      <select id="regionFilter" class="w-full sm:w-auto bg-gray-800 text-white border border-gray-700 px-3 py-2 rounded-lg uppercase shadow focus:outline-none">
        <option value="">Όλες οι περιοχές</option>
        <option>Πόλη</option><option>Ιαλυσός</option><option>Φαληράκι</option><option>Κολύμπια</option><option>Νότια Ρόδος</option><option>Δυτική Ρόδος</option>
      </select>
      <select id="visitedFilter" class="w-full sm:w-auto bg-gray-800 text-white border border-gray-700 px-3 py-2 rounded-lg uppercase shadow focus:outline-none">
        <option value="all">Όλες</option>
        <option value="visited">Επισκεφθείσες</option>
        <option value="unvisited">Μη Επισκεφθείσες</option>
      </select>
    </div>
    <!-- Points Grid -->
    <div id="pointsContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-6"></div>
    <!-- Generate Custom -->
    <button id="generateCustomRouteBtn" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-success text-white px-6 py-3 rounded-full uppercase font-semibold shadow-lg hover:scale-105 transform transition">
      <span id="cancelCustomBtn" class="absolute top-2 right-4 text-white cursor-pointer">✕</span>
      Δημιούργησε Διαδρομή
    </button>
  </main>

  <!-- Add Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center transition-opacity">
    <div class="relative bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-lg transform scale-95 transition-transform">
      <button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800" onclick="document.getElementById('modal').classList.add('opacity-0','pointer-events-none')">✕</button>
      <h2 class="text-center uppercase mb-4">Καταχώριση Σημείου</h2>
      <form id="pointForm" class="space-y-4">
        <div>
          <label class="block uppercase font-medium mb-1">Όνομα Σημείου</label>
          <input id="pointName" class="w-full border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required/>
        </div>
        <div>
          <label class="block uppercase font-medium mb-1">Περιοχή</label>
          <select id="areaSelect" class="w-full border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
            <option value="">Επιλέξτε...</option>
            <option>Πόλη</option><option>Ιαλυσός</option><option>Φαληράκι</option><option>Κολύμπια</option><option>Νότια Ρόδος</option><option>Δυτική Ρόδος</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-300 uppercase rounded-lg">Ακύρωση</button>
          <button type="submit" class="px-4 py-2 bg-primary text-white uppercase rounded-lg">Καταχώριση</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center transition-opacity">
    <div class="relative bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-lg transform scale-95 transition-transform">
      <button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800" onclick="document.getElementById('editModal').classList.add('opacity-0','pointer-events-none')">✕</button>
      <h2 class="text-center uppercase mb-4">Επεξεργασία Σημείου</h2>
      <form id="editForm" class="space-y-4">
        <div>
          <label class="block uppercase font-medium mb-1">Όνομα Σημείου</label>
          <input name="editName" class="w-full border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required/>
        </div>
        <div>
          <label class="block uppercase font-medium mb-1">Περιοχή</label>
          <select name="editArea" class="w-full border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
            <option value="">Επιλέξτε...</option>
            <option>Πόλη</option><option>Ιαλυσός</option><option>Φαληράκι</option><option>Κολύμπια</option><option>Νότια Ρόδος</option><option>Δυτική Ρόδος</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="editCancel" class="px-4 py-2 bg-gray-300 uppercase rounded-lg">Ακύρωση</button>
          <button type="submit" class="px-4 py-2 bg-primary text-white uppercase rounded-lg">Αποθήκευση</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Route Modal -->
  <div id="routeModal" class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center transition-opacity">
    <div class="relative bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-lg transform scale-95 transition-transform">
      <button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800" onclick="document.getElementById('routeModal').classList.add('opacity-0','pointer-events-none')">✕</button>
      <h2 class="text-center uppercase mb-4">Δρομολόγιο Περιοχής</h2>
      <form id="routeForm" class="space-y-4">
        <div><label class="block uppercase font-medium mb-1">Περιοχή</label><select id="routeRegion" class="w-full border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required><option value="all">Όλες οι περιοχές</option><option>Πόλη</option><option>Ιαλυσός</option><option>Φαληράκι</option><option>Κολύμπια</option><option>Νότια Ρόδος</option><option>Δυτική Ρόδος</option></select></div>
        <div><label class="block uppercase font-medium mb-1">Εύρος Ημερών</label><select id="routeDays" class="w-full border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"><option value="all">Όλες</option><option value="lt3">Λιγότερο από 3</option><option value="3to7">3–7</option><option value="gt7">Πάνω από 7</option><option value="never">Ποτέ</option></select></div>
        <p id="routeCount" class="text-center text-gray-700 font-medium"></p>
        <div class="flex justify-end gap-2"><button type="button" id="routeCancel" class="px-4 py-2 bg-gray-300 uppercase rounded-lg">Ακύρωση</button><button type="submit" class="px-4 py-2 bg-success text-white uppercase rounded-lg">Εξέλιξη</button></div>
      </form>
    </div>
  </div>
</body>
</html>
