<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Καταχώριση Σημείου (Firebase)</title>

  <!-- Tailwind CSS + custom colors -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary:  '#1D4ED8',
            accent:   '#FACC15',
            danger:   '#DC2626',
            success:  '#16A34A',
            region:   '#8B5CF6',
            softbg:   '#f0f8ff',
            darktext: '#1f2937'
          }
        }
      }
    }
  </script>

  <!-- Ensure 2-column grid in landscape -->
  <style>
    @media (orientation: landscape) {
      #pointsContainer {
        display: grid !important;
        grid-template-columns: repeat(2, minmax(0,1fr)) !important;
      }
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey:    "AIzaSyDe966NdE-AW_eZrDCEKjw8y2h5mSdHr6o",
      authDomain:"pointregistrationapp.firebaseapp.com",
      projectId: "pointregistrationapp",
      storageBucket:"pointregistrationapp.appspot.com",
      messagingSenderId:"925139386507",
      appId:     "1:925139386507:web:588ae991f39a7bab04548e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    function daysSince(ts) {
      if (!ts) return Infinity;
      const d = ts.toDate(), now = new Date();
      return (now - d)/(1000*60*60*24);
    }

    // Compress image before upload
    function compressImage(file, quality, callback) {
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          canvas.toBlob(blob => callback(blob), 'image/jpeg', quality);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    document.addEventListener("DOMContentLoaded", () => {
      let userLat, userLng, allPoints = [], editId = null, selectionMode = false, currentPhotoId = null;

      // Refs
      const openBtn       = document.getElementById("openModalBtn"),
            addModal      = document.getElementById("modal"),
            cancelBtn     = document.getElementById("cancelBtn"),
            form          = document.getElementById("pointForm"),
            editModal     = document.getElementById("editModal"),
            editCancel    = document.getElementById("editCancel"),
            editForm      = document.getElementById("editForm"),
            routeModal    = document.getElementById("routeModal"),
            routeCancel   = document.getElementById("routeCancel"),
            routeForm     = document.getElementById("routeForm"),
            routeRegion   = document.getElementById("routeRegion"),
            routeDays     = document.getElementById("routeDays"),
            routeCount    = document.getElementById("routeCount"),
            container     = document.getElementById("pointsContainer"),
            regionF       = document.getElementById("regionFilter"),
            visitedF      = document.getElementById("visitedFilter"),
            routeBtn      = document.getElementById("routeBtn"),
            customBtn     = document.getElementById("customRouteBtn"),
            genBtn        = document.getElementById("generateCustomRouteBtn"),
            cancelGen     = document.getElementById("cancelCustomBtn"),
            photoInput    = document.getElementById("photoInput"),
            photoModal    = document.getElementById("photoModal"),
            photoImg      = document.getElementById("photoImg"),
            photoDate     = document.getElementById("photoDate"),
            deletePhoto   = document.getElementById("deletePhotoBtn"),
            closePhotoBtn = document.getElementById("closePhotoModal");

      // Add point
      openBtn.onclick = () => {
        if (!navigator.geolocation) { alert("Δεν υποστηρίζεται γεωεντοπισμός."); return; }
        navigator.geolocation.getCurrentPosition(pos => {
          userLat = pos.coords.latitude; userLng = pos.coords.longitude;
          addModal.classList.remove("opacity-0","pointer-events-none");
        }, ()=> alert("Άδεια τοποθεσίας απαραίτητη."));
      };
      cancelBtn.onclick = () => {
        addModal.classList.add("opacity-0","pointer-events-none");
        form.reset();
      };
      form.onsubmit = async e => {
        e.preventDefault();
        const name = form.pointName.value.trim(),
              area = form.areaSelect.value;
        if (!name || !area) { alert("Συμπληρώστε όλα τα πεδία."); return; }
        await db.collection("points").add({
          name, area,
          latitude: userLat,
          longitude: userLng,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        cancelBtn.click();
      };

      // Edit point
      editCancel.onclick = () => {
        editModal.classList.add("opacity-0","pointer-events-none");
        editForm.reset();
      };
      editForm.onsubmit = async e => {
        e.preventDefault();
        const name = editForm.editName.value.trim(),
              area = editForm.editArea.value;
        if (!name || !area) { alert("Συμπληρώστε όλα τα πεδία."); return; }
        await db.collection("points").doc(editId).update({ name, area });
        editCancel.click();
      };

      // Route
      routeBtn.onclick = () => {
        routeModal.classList.remove("opacity-0","pointer-events-none");
        updateRouteCount();
      };
      routeCancel.onclick = () => {
        routeModal.classList.add("opacity-0","pointer-events-none");
        routeForm.reset(); routeCount.textContent="";
      };
      routeRegion.onchange = updateRouteCount;
      routeDays.onchange   = updateRouteCount;
      routeForm.onsubmit = e => {
        e.preventDefault();
        const sel = routeRegion.value, daysOpt = routeDays.value;
        if (!sel) { alert("Επιλέξτε περιοχή."); return; }
        let pts = allPoints.filter(p=> sel==='all'||p.area===sel)
                           .filter(p=> {
                             const age = daysSince(p.lastVisit);
                             return ({
                               lt3:   age<3, '3to7':age>=3&&age<=7,
                               gt7:   age>7, never: !p.lastVisit
                             }[daysOpt] ?? true);
                           });
        if (pts.length < 2) { alert("Δεν υπάρχουν αρκετά σημεία."); return; }
        pts.sort((a,b)=>a.timestamp.seconds - b.timestamp.seconds);
        const coords    = pts.map(p=>`${p.latitude},${p.longitude}`),
              origin    = coords.shift(),
              dest      = coords.pop(),
              waypoints = coords.join("|");
        let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}`;
        if (waypoints) url += `&waypoints=${waypoints}`;
        window.open(url, "_blank"); routeCancel.click();
      };
      function updateRouteCount(){
        const sel = routeRegion.value, daysOpt = routeDays.value;
        if (!sel) return void(routeCount.textContent="");
        const cnt = allPoints.filter(p=> sel==='all'||p.area===sel)
                             .filter(p=>{
                               const age = daysSince(p.lastVisit);
                               return ({
                                 lt3:   age<3, '3to7':age>=3&&age<=7,
                                 gt7:   age>7, never: !p.lastVisit
                               }[daysOpt] ?? true);
                             }).length;
        routeCount.textContent = `Βρέθηκαν ${cnt} σημεία`;
      }

      // Custom route
      customBtn.onclick = () => {
        selectionMode = true;
        genBtn.classList.remove("hidden");
        cancelGen.classList.remove("hidden");
        render();
      };
      cancelGen.onclick = e => {
        e.stopPropagation();
        selectionMode = false;
        genBtn.classList.add("hidden");
        cancelGen.classList.add("hidden");
        render();
      };
      genBtn.onclick = () => {
        const checked = container.querySelectorAll("input[type=checkbox]:checked");
        if (!checked.length) { alert("Επιλέξτε σημεία."); return; }
        const coords = [...checked].map(cb => {
          const p = allPoints.find(x=>x.id===cb.dataset.id);
          return `${p.latitude},${p.longitude}`;
        });
        const origin      = coords.shift(),
              destination = coords.pop(),
              waypoints   = coords.join("|");
        let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;
        if (waypoints) url += `&waypoints=${waypoints}`;
        window.open(url, "_blank"); cancelGen.click();
      };

      // Photo capture & preview
      photoInput.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        compressImage(file, 0.7, async blob => {
          const ref = storage.ref(`points/${currentPhotoId}.jpg`);
          await ref.put(blob);
          const url = await ref.getDownloadURL();
          const ts  = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('points').doc(currentPhotoId)
                  .update({ photoURL: url, photoTimestamp: ts });
          showPhotoModal(currentPhotoId);
        });
      };
      deletePhoto.onclick = async () => {
        if (!currentPhotoId) return;
        await storage.ref(`points/${currentPhotoId}.jpg`).delete();
        await db.collection('points').doc(currentPhotoId)
                .update({
                  photoURL: firebase.firestore.FieldValue.delete(),
                  photoTimestamp: firebase.firestore.FieldValue.delete()
                });
        photoModal.classList.add("opacity-0","pointer-events-none");
      };
      closePhotoBtn.onclick = () => {
        photoModal.classList.add("opacity-0","pointer-events-none");
      };

      // Firestore listener
      db.collection("points").orderBy("timestamp","desc")
        .onSnapshot(snap => { allPoints = snap.docs.map(d=>({id:d.id,...d.data()})); render(); });
      regionF.onchange  = render;
      visitedF.onchange = render;

      function render(){
        container.innerHTML = "";
        const sel = regionF.value, vis = visitedF.value;
        allPoints.forEach(pt => {
          const visited = !!pt.lastVisit;
          if ((sel === '' || pt.area === sel) &&
              (vis === 'all' || (vis === 'visited' && visited) || (vis === 'unvisited' && !visited))) {
            container.append(card(pt));
          }
        });
      }

      function showPhotoModal(id){
        currentPhotoId = id;
        db.collection('points').doc(id).get().then(doc => {
          const data = doc.data() || {};
          if (!data.photoURL) {
            photoInput.click();
            return;
          }
          photoImg.src = data.photoURL;
          photoDate.textContent = new Date(data.photoTimestamp.toDate()).toLocaleString();
          photoModal.classList.remove("opacity-0","pointer-events-none");
        });
      }

      function card(pt){
        const c = document.createElement("div");
        c.className = "relative bg-white rounded-xl p-4 shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition overflow-hidden";

        // area banner
        const areaBanner = document.createElement("div");
        areaBanner.className = "absolute top-2 left-1/2 transform -translate-x-1/2 bg-region text-white px-2 py-0.5 rounded-full text-xs uppercase font-semibold";
        areaBanner.textContent = pt.area; c.append(areaBanner);

        // checkbox
        if (selectionMode){
          const cb = document.createElement("input");
          cb.type = "checkbox"; cb.className = "absolute top-2 right-2 form-checkbox h-4 w-4 text-primary";
          cb.dataset.id = pt.id; c.append(cb);
        }

        // wrapper
        const wrapper = document.createElement("div");
        wrapper.className = "mt-6 flex flex-col md:flex-row justify-between items-center gap-2";

        // left block
        const left = document.createElement("div");
        left.className = "flex flex-col items-center gap-1 min-w-0";
        const age = daysSince(pt.lastVisit);
        const dotClass = (age===Infinity||age>7) ? "bg-danger animate-pulse" :
                         (age>3)           ? "bg-accent animate-ping" :
                                             "bg-success";
        const dot = document.createElement("span");
        dot.className = `w-2 h-2 ${dotClass} rounded-full`;
        const lbl = document.createElement("span");
        lbl.className = "text-xs text-gray-500 uppercase";
        lbl.textContent = age===Infinity?"Ποτέ":
                          Math.floor(age)===1?"1 ημέρα":`${Math.floor(age)} ημέρες`;
        const title = document.createElement("h3");
        title.className = "text-lg font-bold uppercase text-darktext text-center break-words whitespace-normal";
        title.textContent = pt.name;
        left.append(dot, lbl, title);

        // right block (buttons)
        const right = document.createElement("div");
        right.className = "flex items-center gap-1 flex-shrink-0";
        ['Επίσκεψη','Αλλαγή','Διαγραφή','Προβολή'].forEach(label=>{
          const btn = document.createElement("button");
          btn.className = "px-2 py-1 bg-primary text-white text-xs rounded uppercase";
          if (label==='Αλλαγή') btn.classList.replace('bg-primary','bg-accent');
          if (label==='Διαγραφή') btn.classList.replace('bg-primary','bg-danger');
          if (label==='Προβολή') btn.classList.replace('bg-primary','bg-region');
          btn.textContent = label;
          btn.onclick = {
            'Επίσκεψη': async ()=>{
              const now = new Date();
              await db.collection("points").doc(pt.id)
                       .update({ lastVisit: firebase.firestore.FieldValue.serverTimestamp() });
              pt.lastVisit = { toDate:()=>now };
              render();
            },
            'Αλλαγή': ()=>{
              editId = pt.id;
              editForm.editName.value = pt.name;
              editForm.editArea.value = pt.area;
              editModal.classList.remove("opacity-0","pointer-events-none");
            },
            'Διαγραφή': async ()=>{
              if (confirm("Διαγραφή;")) await db.collection("points").doc(pt.id).delete();
            },
            'Προβολή': ()=> showPhotoModal(pt.id)
          }[label];
          right.append(btn);
        });
        wrapper.append(left, right);
        c.append(wrapper);

        // last visit info
        if (pt.lastVisit){
          const info = document.createElement("p");
          info.className = "text-xs text-gray-500 italic mt-1 text-center";
          info.textContent = "Τελευταία επίσκεψη: "+pt.lastVisit.toDate().toLocaleString();
          c.append(info);
        }

        // map link
        const m = document.createElement("a");
        m.href = `https://www.google.com/maps/search/?api=1&query=${pt.latitude},${pt.longitude}`;
        m.target = "_blank";
        m.className = "block text-center bg-primary text-white py-1 rounded uppercase text-xs mt-2";
        m.textContent = "Χάρτης";
        c.append(m);

        return c;
      }
    });
  </script>
</head>

<body class="bg-softbg text-darktext min-h-screen flex flex-col items-center py-8 font-sans">
  <!-- Header -->
  <header class="w-full bg-white shadow py-3 mb-6">
    <div class="max-w-3xl mx-auto px-4 flex justify-between items-center">
      <h1 class="text-2xl font-extrabold text-primary uppercase">Καταχώριση Σημείου</h1>
      <button id="openModalBtn" class="bg-primary text-white w-10 h-10 rounded-full flex items-center justify-center text-xl">+</button>
    </div>
  </header>

  <!-- Main -->
  <main class="w-full max-w-3xl px-4 space-y-4 mb-8">
    <div class="flex justify-center">
      <a href="http://treno2025.unaux.com/" target="_blank" class="px-4 py-1 bg-primary text-white rounded uppercase text-sm">Παραγγελίες</a>
    </div>
    <div class="flex flex-col md:flex-row gap-2 justify-between items-center">
      <select id="regionFilter" class="flex-1 border px-2 py-1 rounded uppercase text-sm">
        <option value="">Όλες οι περιοχές</option>
        <option>Πόλη</option><option>Ιαλυσός</option><option>Φαληράκι</option><option>Κολύμπια</option><option>Νότια Ρόδος</option><option>Δυτική Ρόδος</option>
      </select>
      <select id="visitedFilter" class="border px-2 py-1 rounded uppercase text-sm">
        <option value="all">Όλες</option>
        <option value="visited">Επισκεφθείσες</option>
        <option value="unvisited">Μη Επισκεφθείσες</option>
      </select>
      <div class="flex gap-2">
        <button id="routeBtn" class="bg-indigo-500 text-white px-3 py-1 rounded uppercase text-xs">Δρομολ. Περιοχής</button>
        <button id="customRouteBtn" class="bg-teal-500 text-white px-3 py-1 rounded uppercase text-xs">Προσαρμ. Διαδρομή</button>
      </div>
    </div>
    <div id="pointsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
    <button id="generateCustomRouteBtn" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-indigo-600 text-white px-4 py-1 rounded uppercase text-sm z-50">
      <span id="cancelCustomBtn" class="absolute top-1 right-2 text-white text-lg">✕</span>
      Δημιούργησε Διαδρομή
    </button>
  </main>

  <!-- Hidden file input for camera -->
  <input type="file" accept="image/*" capture="environment" id="photoInput" class="hidden"/>

  <!-- Photo Modal -->
  <div id="photoModal" class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center">
    <div class="bg-white rounded p-4 w-full max-w-sm relative">
      <button id="closePhotoModal" class="absolute top-2 right-2 text-gray-600 text-xl">✕</button>
      <img id="photoImg" class="w-full h-auto rounded mb-2"/>
      <p id="photoDate" class="text-center text-gray-600 text-xs mb-2"></p>
      <button id="deletePhotoBtn" class="block mx-auto bg-danger text-white px-3 py-1 rounded uppercase text-xs">Διαγραφή</button>
    </div>
  </div>

  <!-- Add Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center">
    <div class="bg-white rounded p-4 w-full max-w-sm relative">
      <button class="absolute top-2 right-2 text-gray-600 text-xl" onclick="document.getElementById('modal').classList.add('opacity-0','pointer-events-none')">✕</button>
      <h2 class="text-center uppercase mb-4 text-primary text-xl font-semibold">Καταχώριση Σημείου</h2>
      <form id="pointForm" class="space-y-4">
        <div>
          <label class="block uppercase font-medium mb-1">Όνομα Σημείου</label>
          <input id="pointName" class="w-full border px-3 py-2 rounded uppercase focus:outline-none focus:ring-2 focus:ring-primary" required/>
        </div>
        <div>
          <label class="block uppercase font-medium mb-1">Περιοχή</label>
          <select id="areaSelect" class="w-full border px-3 py-2 rounded uppercase focus:outline-none focus:ring-2 focus:ring-region" required>
            <option value="">Επιλέξτε...</option>
            <option>Πόλη</option><option>Ιαλυσός</option><option>Φαληράκι</option><option>Κολύμπια</option><option>Νότια Ρόδος</option><option>Δυτική Ρόδος</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-300 text-gray-800 uppercase rounded hover:bg-gray-400">Ακύρωση</button>
          <button type="submit" class="px-4 py-2 bg-primary text-white uppercase rounded hover:bg-primary/90">Καταχώριση</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center">
    <div class="bg-white rounded p-4 w-full max-w-sm relative">
      <button class="absolute top-2 right-2 text-gray-600 text-xl" onclick="document.getElementById('editModal').classList.add('opacity-0','pointer-events-none')">✕</button>
      <h2 class="text-center uppercase mb-4 text-primary text-xl font-semibold">Επεξεργασία Σημείου</h2>
      <form id="editForm" class="space-y-4">
        <div>
          <label class="block uppercase font-medium mb-1">Όνομα Σημείου</label>
          <input name="editName" class="w-full border px-3 py-2 rounded uppercase focus:outline-none focus:ring-2 focus:ring-primary" required/>
        </div>
        <div>
          <label class="block uppercase font-medium mb-1">Περιοχή</label>
          <select name="editArea" class="w-full border px-3 py-2 rounded uppercase focus:outline-none focus:ring-2 focus:ring-region" required>
            <option value="">Επιλέξτε...</option>
            <option>Πόλη</option><option>Ιαλυσός</option><option>Φαληράκι</option><option>Κολύμπια</option><option>Νότια Ρόδος</option><option>Δυτική Ρόδος</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="editCancel" class="px-4 py-2 bg-gray-300 text-gray-800 uppercase rounded hover:bg-gray-400">Ακύρωση</button>
          <button type="submit" class="px-4 py-2 bg-primary text-white uppercase rounded hover:bg-primary/90">Αποθήκευση</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Route Modal -->
  <div id="routeModal" class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center">
    <div class="bg-white rounded p-4 w-full max-w-sm relative">
      <button class="absolute top-2 right-2 text-gray-600 text-xl" onclick="document.getElementById('routeModal').classList.add('opacity-0','pointer-events-none')">✕</button>
      <h2 class="text-center uppercase mb-4 text-primary text-xl font-semibold">Δρομολόγιο Περιοχής</h2>
      <form id="routeForm" class="space-y-4">
        <div>
          <label class="block uppercase font-medium mb-1">Περιοχή</label>
          <select id="routeRegion" class="w-full border px-3 py-2 rounded uppercase focus:outline-none focus:ring-2 focus:ring-region" required>
            <option value="all">Όλες οι περιοχές</option>
            <option>Πόλη</option><option>Ιαλυσός</option><option>Φαληράκι</option><option>Κολύμπια</option><option>Νότια Ρόδος</option><option>Δυτική Ρόδος</option>
          </select>
        </div>
        <div>
          <label class="block uppercase font-medium mb-1">Εύρος Ημερών</label>
          <select id="routeDays" class="w-full border px-3 py-2 rounded uppercase focus:outline-none focus:ring-2 focus:ring-primary">
            <option value="all">Όλες</option><option value="lt3">Λιγότερο από 3</option><option value="3to7">3–7</option><option value="gt7">Πάνω από 7</option><option value="never">Ποτέ</option>
          </select>
        </div>
        <p id="routeCount" class="text-center text-gray-700 text-sm"></p>
        <div class="flex justify-end gap-2">
          <button type="button" id="routeCancel" class="px-4 py-2 bg-gray-300 text-gray-800 uppercase rounded hover:bg-gray-400">Ακύρωση</button>
          <button type="submit" class="px-4 py-2 bg-success text-white uppercase rounded hover:bg-success/90">Εξέλιξη</button>
        </div>
      </form>
    </div>
  </div>
</body>
</html>
