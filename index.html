<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Καταχώριση Σημείου (Firebase)</title>

  <!-- Tailwind + custom colors -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1D4ED8',
            accent:  '#FACC15',
            danger:  '#DC2626',
            success: '#16A34A',
            region:  '#8B5CF6',
            softbg:  '#f0f8ff',
            darktext:'#1f2937'
          }
        }
      }
    }
  </script>

  <style>
    @media (orientation: landscape) {
      #pointsContainer {
        display: grid !important;
        grid-template-columns: repeat(2,1fr) !important;
      }
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
</head>
<body class="bg-softbg text-darktext min-h-screen flex flex-col items-center py-8">

  <!-- Header -->
  <header class="w-full bg-white shadow py-3 mb-6">
    <div class="max-w-3xl mx-auto px-4 flex justify-between items-center">
      <h1 class="text-2xl font-extrabold text-primary uppercase">Καταχώριση Σημείου</h1>
      <button id="openModalBtn" class="bg-primary text-white w-10 h-10 rounded-full flex items-center justify-center text-xl">+</button>
    </div>
  </header>

  <!-- Controls -->
  <main class="w-full max-w-3xl px-4 space-y-4 mb-8">
    <div class="flex justify-center">
      <a href="http://treno2025.unaux.com/" target="_blank" class="px-4 py-1 bg-primary text-white rounded uppercase text-sm">Παραγγελίες</a>
    </div>
    <div class="flex flex-col md:flex-row gap-2 justify-between items-center">
      <select id="regionFilter" class="flex-1 border px-2 py-1 rounded uppercase text-sm">
        <option value="">Όλες οι περιοχές</option>
        <option>Πόλη</option><option>Ιαλυσός</option><option>Φαληράκι</option>
        <option>Κολύμπια</option><option>Νότια Ρόδος</option><option>Δυτική Ρόδος</option>
      </select>
      <select id="visitedFilter" class="border px-2 py-1 rounded uppercase text-sm">
        <option value="all">Όλες</option>
        <option value="visited">Επισκεφθείσες</option>
        <option value="unvisited">Μη Επισκεφθείσες</option>
      </select>
      <div class="flex gap-2">
        <button id="routeBtn" class="bg-indigo-500 text-white px-3 py-1 rounded uppercase text-xs">Δρομολ. Περιοχής</button>
        <button id="customRouteBtn" class="bg-teal-500 text-white px-3 py-1 rounded uppercase text-xs">Προσαρμ. Διαδρομή</button>
      </div>
    </div>
    <div id="pointsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
    <button id="generateCustomRouteBtn" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-indigo-600 text-white px-4 py-1 rounded uppercase text-sm z-50">
      <span id="cancelCustomBtn" class="absolute top-1 right-2 text-white text-lg cursor-pointer">✕</span>
      Δημιούργησε Διαδρομή
    </button>
  </main>

  <!-- Modals -->
  <!-- Add Point -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center">
    <div class="bg-white rounded p-4 w-full max-w-sm relative">
      <button class="absolute top-2 right-2" onclick="document.getElementById('modal').classList.add('opacity-0','pointer-events-none')">✕</button>
      <h2 class="text-center uppercase mb-4 text-primary font-semibold">Καταχώριση Σημείου</h2>
      <form id="pointForm" class="space-y-4">
        <div>
          <label class="block uppercase mb-1">Όνομα Σημείου</label>
          <input id="pointName" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-primary" required/>
        </div>
        <div>
          <label class="block uppercase mb-1">Περιοχή</label>
          <select id="areaSelect" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-region" required>
            <option value="">Επιλέξτε...</option>
            <option>Πόλη</option><option>Ιαλυσός</option><option>Φαληράκι</option><option>Κολύμπια</option><option>Νότια Ρόδος</option><option>Δυτική Ρόδος</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-300 rounded">Ακύρωση</button>
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded">Καταχώριση</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Point -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center">
    <div class="bg-white rounded p-4 w-full max-w-sm relative">
      <button class="absolute top-2 right-2" onclick="document.getElementById('editModal').classList.add('opacity-0','pointer-events-none')">✕</button>
      <h2 class="text-center uppercase mb-4 text-primary font-semibold">Επεξεργασία Σημείου</h2>
      <form id="editForm" class="space-y-4">
        <div>
          <label class="block uppercase mb-1">Όνομα Σημείου</label>
          <input name="editName" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-primary" required/>
        </div>
        <div>
          <label class="block uppercase mb-1">Περιοχή</label>
          <select name="editArea" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-region" required>
            <option value="">Επιλέξτε...</option>
            <option>Πόλη</option><option>Ιαλυσός</option><option>Φαληράκι</option><option>Κολύμπια</option><option>Νότια Ρόδος</option><option>Δυτική Ρόδος</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="editCancel" class="px-4 py-2 bg-gray-300 rounded">Ακύρωση</button>
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded">Αποθήκευση</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Route Modal -->
  <div id="routeModal" class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center">
    <div class="bg-white rounded p-4 w-full max-w-sm relative">
      <button class="absolute top-2 right-2" onclick="document.getElementById('routeModal').classList.add('opacity-0','pointer-events-none')">✕</button>
      <h2 class="text-center uppercase mb-4 text-primary font-semibold">Δρομολόγιο Περιοχής</h2>
      <form id="routeForm" class="space-y-4">
        <div>
          <label class="block uppercase mb-1">Περιοχή</label>
          <select id="routeRegion" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-region" required>
            <option value="all">Όλες οι περιοχές</option>
            <option>Πόλη</option><option>Ιαλυσός</option><option>Φαληράκι</option><option>Κολύμπια</option><option>Νότια Ρόδος</option><option>Δυτική Ρόδος</option>
          </select>
        </div>
        <div>
          <label class="block uppercase mb-1">Εύρος Ημερών</label>
          <select id="routeDays" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-primary">
            <option value="all">Όλες</option><option value="lt3">Λιγότερο από 3</option><option value="3to7">3–7</option><option value="gt7">Πάνω από 7</option><option value="never">Ποτέ</option>
          </select>
        </div>
        <p id="routeCount" class="text-center text-gray-700 text-sm"></p>
        <div class="flex justify-end gap-2">
          <button type="button" id="routeCancel" class="px-4 py-2 bg-gray-300 rounded">Ακύρωση</button>
          <button type="submit" class="px-4 py-2 bg-success text-white rounded">Εξέλιξη</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Hidden file input -->
  <input id="photoInput" type="file" accept="image/*" capture style="display:none"/>

  <!-- Photo Preview Modal -->
  <div id="photoModal" class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center">
    <div class="bg-white rounded p-4 w-full max-w-sm relative">
      <button id="closePhotoModal" class="absolute top-2 right-2">✕</button>
      <img id="photoImg" class="w-full h-auto rounded mb-2"/>
      <p id="photoDate" class="text-center text-gray-600 text-xs mb-2"></p>
      <button id="deletePhotoBtn" class="block mx-auto bg-danger text-white px-3 py-1 rounded uppercase text-xs">Διαγραφή</button>
    </div>
  </div>

  <script>
    // 1. Initialize Firebase με το σωστό storageBucket
    const firebaseConfig = {
      apiKey:    "AIzaSyDe966NdE-AW_eZrDCEKjw8y2h5mSdHr6o",
      authDomain:"pointregistrationapp.firebaseapp.com",
      projectId: "pointregistrationapp",
      storageBucket:"pointregistrationapp.firebasestorage.app",
      messagingSenderId:"925139386507",
      appId:     "1:925139386507:web:588ae991f39a7bab04548e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(), storage = firebase.storage();

    function daysSince(ts){
      if(!ts) return Infinity;
      return (new Date() - ts.toDate())/(1000*60*60*24);
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      let userLat, userLng, allPoints=[], editId, selectionMode=false, currentPhotoId;

      const openBtn=document.getElementById("openModalBtn"),
            addModal=document.getElementById("modal"),
            cancelBtn=document.getElementById("cancelBtn"),
            form=document.getElementById("pointForm"),
            editModal=document.getElementById("editModal"),
            editCancel=document.getElementById("editCancel"),
            editForm=document.getElementById("editForm"),
            routeModal=document.getElementById("routeModal"),
            routeCancel=document.getElementById("routeCancel"),
            routeForm=document.getElementById("routeForm"),
            routeRegion=document.getElementById("routeRegion"),
            routeDays=document.getElementById("routeDays"),
            routeCount=document.getElementById("routeCount"),
            container=document.getElementById("pointsContainer"),
            regionF=document.getElementById("regionFilter"),
            visitedF=document.getElementById("visitedFilter"),
            routeBtn=document.getElementById("routeBtn"),
            customBtn=document.getElementById("customRouteBtn"),
            genBtn=document.getElementById("generateCustomRouteBtn"),
            cancelGen=document.getElementById("cancelCustomBtn"),
            photoInput=document.getElementById("photoInput"),
            photoModal=document.getElementById("photoModal"),
            photoImg=document.getElementById("photoImg"),
            photoDate=document.getElementById("photoDate"),
            deletePhoto=document.getElementById("deletePhotoBtn"),
            closePhoto=document.getElementById("closePhotoModal");

      // --- Add Point ---
      openBtn.onclick=()=>{
        navigator.geolocation.getCurrentPosition(pos=>{
          userLat=pos.coords.latitude; userLng=pos.coords.longitude;
          addModal.classList.remove("opacity-0","pointer-events-none");
        },()=>alert("Άδεια τοποθεσίας απαραίτητη."));
      };
      cancelBtn.onclick=()=>{
        addModal.classList.add("opacity-0","pointer-events-none"); form.reset();
      };
      form.onsubmit=async e=>{
        e.preventDefault();
        const name=form.pointName.value.trim(), area=form.areaSelect.value;
        if(!name||!area){ alert("Συμπληρώστε όλα τα πεδία."); return; }
        try {
          await db.collection("points").add({
            name, area,
            latitude:userLat, longitude:userLng,
            timestamp:firebase.firestore.FieldValue.serverTimestamp()
          });
          cancelBtn.click();
        } catch(err) {
          console.error("Firestore add error:",err);
          alert("Σφάλμα αποθήκευσης σημείου: "+err.message);
        }
      };

      // --- Edit Point ---
      editCancel.onclick=()=>{
        editModal.classList.add("opacity-0","pointer-events-none"); editForm.reset();
      };
      editForm.onsubmit=async e=>{
        e.preventDefault();
        const name=editForm.editName.value.trim(), area=editForm.editArea.value;
        if(!name||!area){ alert("Συμπληρώστε όλα τα πεδία."); return; }
        try{
          await db.collection("points").doc(editId).update({ name, area });
          editCancel.click();
        } catch(err){
          console.error("Firestore update error:",err);
          alert("Σφάλμα ενημέρωσης σημείου: "+err.message);
        }
      };

      // --- Route by area ---
      routeBtn.onclick=()=>{
        routeModal.classList.remove("opacity-0","pointer-events-none");
        updateRouteCount();
      };
      routeCancel.onclick=()=>{
        routeModal.classList.add("opacity-0","pointer-events-none");
        routeForm.reset(); routeCount.textContent="";
      };
      routeForm.onsubmit=e=>{
        e.preventDefault();
        const sel=routeRegion.value, days=routeDays.value;
        if(!sel){ alert("Επιλέξτε περιοχή."); return; }
        let pts=allPoints.filter(p=>sel==='all'||p.area===sel)
          .filter(p=>{
            const age=daysSince(p.lastVisit||0);
            return ({ lt3:age<3,'3to7':age>=3&&age<=7,gt7:age>7,never:!p.lastVisit }[days]||false);
          });
        if(pts.length<2){ alert("Δεν υπάρχουν αρκετά σημεία."); return; }
        pts.sort((a,b)=>a.timestamp.seconds-b.timestamp.seconds);
        const coords=pts.map(p=>`${p.latitude},${p.longitude}`),
              o=coords.shift(), d=coords.pop(), w=coords.join("|");
        let url=`https://www.google.com/maps/dir/?api=1&origin=${o}&destination=${d}`;
        if(w) url+=`&waypoints=${w}`;
        window.open(url,"_blank"); routeCancel.click();
      };
      function updateRouteCount(){
        const sel=routeRegion.value, days=routeDays.value;
        if(!sel){ routeCount.textContent=""; return; }
        const cnt=allPoints.filter(p=>sel==='all'||p.area===sel)
          .filter(p=>{
            const age=daysSince(p.lastVisit||0);
            return ({ lt3:age<3,'3to7':age>=3&&age<=7,gt7:age>7,never:!p.lastVisit }[days]||false);
          }).length;
        routeCount.textContent=`Βρέθηκαν ${cnt} σημεία`;
      }

      // --- Custom Route ---
      customBtn.onclick=()=>{
        selectionMode=true; genBtn.classList.remove("hidden"); cancelGen.classList.remove("hidden"); render();
      };
      cancelGen.onclick=e=>{
        e.stopPropagation(); selectionMode=false; genBtn.classList.add("hidden"); cancelGen.classList.add("hidden"); render();
      };
      genBtn.onclick=()=>{
        const checked=[...container.querySelectorAll("input[type=checkbox]:checked")];
        if(!checked.length){ alert("Επιλέξτε σημεία."); return; }
        const coords=checked.map(cb=>{
          const p=allPoints.find(x=>x.id===cb.dataset.id);
          return `${p.latitude},${p.longitude}`;
        });
        const o=coords.shift(), d=coords.pop(), w=coords.join("|");
        let url=`https://www.google.com/maps/dir/?api=1&origin=${o}&destination=${d}`;
        if(w) url+=`&waypoints=${w}`;
        window.open(url,"_blank"); cancelGen.click();
      };

      // --- Photo upload via hidden input ---
      function showPhoto(id){
        currentPhotoId=id;
        photoInput.click();
      }
      photoInput.onchange=async ()=>{
        const file=photoInput.files[0];
        if(!file||!currentPhotoId) return;
        if(!confirm("Θέλεις να αποθηκεύσεις τη φωτογραφία;")) return;
        try {
          const ref=storage.ref(`points/${currentPhotoId}.jpg`);
          const snap=await ref.put(file);
          console.log("Uploaded to",snap.metadata.fullPath);
          const url=await ref.getDownloadURL();
          console.log("Download URL:",url);
          const ts=firebase.firestore.FieldValue.serverTimestamp();
          await db.collection("points").doc(currentPhotoId)
                  .update({ photoURL:url, photoTimestamp:ts });
          console.log("Firestore doc updated");
          photoImg.src=url;
          photoDate.textContent=new Date().toLocaleString();
          photoModal.classList.remove("opacity-0","pointer-events-none");
        } catch(err){
          console.error("Upload error:",err);
          alert("Σφάλμα upload: "+err.message);
        }
      };

      deletePhoto.onclick=async()=>{
        try{
          await storage.ref(`points/${currentPhotoId}.jpg`).delete();
          await db.collection("points").doc(currentPhotoId).update({
            photoURL:firebase.firestore.FieldValue.delete(),
            photoTimestamp:firebase.firestore.FieldValue.delete()
          });
          photoModal.classList.add("opacity-0","pointer-events-none");
        }catch(err){
          console.error("Delete error:",err);
          alert("Σφάλμα διαγραφής φωτογραφίας: "+err.message);
        }
      };
      closePhoto.onclick=()=>photoModal.classList.add("opacity-0","pointer-events-none");

      // --- Firestore listener ---
      db.collection("points").orderBy("timestamp","desc")
        .onSnapshot(snap=>{
          allPoints=snap.docs.map(d=>({id:d.id,...d.data()}));
          render();
        },err=>{
          console.error("onSnapshot error:",err);
          alert("Σφάλμα ανάγνωσης δεδομένων: "+err.message);
        });

      regionF.onchange=render; visitedF.onchange=render;

      function render(){
        container.innerHTML="";
        const sel=regionF.value, vis=visitedF.value;
        allPoints.forEach(pt=>{
          const v=!!pt.lastVisit;
          if((sel===""||pt.area===sel)&&(vis==="all"||(vis==="visited"&&v)||(vis==="unvisited"&&!v))){
            container.append(card(pt));
          }
        });
      }

      function card(pt){
        const c=document.createElement("div");
        c.className="relative bg-white rounded-xl p-4 shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition overflow-hidden";

        // area badge
        const ab=document.createElement("div");
        ab.className="absolute top-2 left-1/2 transform -translate-x-1/2 bg-region text-white px-2 py-0.5 rounded-full text-xs uppercase";
        ab.textContent=pt.area; c.append(ab);

        // title
        const h3=document.createElement("h3");
        h3.className="mt-6 text-center text-lg font-bold uppercase text-darktext break-words";
        h3.textContent=pt.name; c.append(h3);

        // row (age + buttons)
        const row=document.createElement("div");
        row.className="mt-4 flex justify-between items-center";
        const ageDiv=document.createElement("div");
        const age=daysSince(pt.lastVisit||0);
        const dc=age===Infinity||age>7?"bg-danger animate-pulse":age>3?"bg-accent animate-ping":"bg-success";
        ageDiv.innerHTML=`<span class="${dc} inline-block w-2 h-2 rounded-full"></span>
                          <span class="text-xs text-gray-500 uppercase ml-1">
                            ${age===Infinity?"Ποτέ":Math.floor(age)===1?"1 ημέρα":`${Math.floor(age)} ημέρες`}
                          </span>`;
        row.append(ageDiv);

        const btns=document.createElement("div");
        btns.className="flex gap-1";
        ["Επίσκεψη","Αλλαγή","Διαγραφή","Προβολή"].forEach(lbl=>{
          const b=document.createElement("button");
          b.className="px-2 py-1 text-xs rounded text-white";
          b.classList.add(lbl==="Επίσκεψη"?"bg-success":lbl==="Αλλαγή"?"bg-accent":lbl==="Διαγραφή"?"bg-danger":"bg-region");
          b.textContent=lbl;
          b.onclick={
            "Επίσκεψη":async()=>{
              const now=new Date();
              await db.collection("points").doc(pt.id)
                       .update({ lastVisit:firebase.firestore.FieldValue.serverTimestamp() });
              pt.lastVisit={toDate:()=>now}; render();
            },
            "Αλλαγή":()=>{
              editId=pt.id; editForm.editName.value=pt.name; editForm.editArea.value=pt.area;
              editModal.classList.remove("opacity-0","pointer-events-none");
            },
            "Διαγραφή":async()=>{ if(confirm("Διαγραφή;")) await db.collection("points").doc(pt.id).delete(); },
            "Προβολή":()=>showPhoto(pt.id)
          }[lbl];
          btns.append(b);
        });
        row.append(btns);
        c.append(row);

        if(pt.lastVisit){
          const p=document.createElement("p");
          p.className="text-xs text-gray-500 italic mt-2 text-center";
          p.textContent="Τελευταία επίσκεψη: "+pt.lastVisit.toDate().toLocaleString();
          c.append(p);
        }

        const a=document.createElement("a");
        a.href=`https://www.google.com/maps/search/?api=1&query=${pt.latitude},${pt.longitude}`;
        a.target="_blank";
        a.className="block text-center bg-primary text-white py-1 rounded uppercase text-xs mt-2";
        a.textContent="Χάρτης";
        c.append(a);

        return c;
      }
    });  
  </script>
</body>
</html>
