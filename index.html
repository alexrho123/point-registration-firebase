<!DOCTYPE html>

<html lang="el">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>Καταχώριση Σημείου (Firebase) με ταξινόμηση &amp; Παραγγελίες</title>
<!-- Tailwind CSS + custom colors -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1D4ED8',
            accent:  '#FACC15',
            danger:  '#DC2626',
            success: '#16A34A',
            region:  '#8B5CF6',
            softbg:  '#f0f8ff',
            darktext:'#1f2937'
          }
        }
      }
    }
  </script>
<style>
    @media (orientation: landscape) {
      #pointsContainer {
        display: grid !important;
        grid-template-columns: repeat(2,1fr) !important;
      }
    }
    #cameraModal, #photoModal, #orderModal {
      transition: opacity 0.2s ease;
    }
    .modal-inner {
      max-height: 90vh;
      overflow-y: auto;
    }
  </style>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body class="bg-softbg text-darktext min-h-screen flex flex-col items-center py-8 font-sans">
<!-- Header -->
<header class="w-full bg-white shadow py-3 mb-6">
<div class="max-w-3xl mx-auto px-4 flex justify-between items-center">
<h1 class="text-2xl font-extrabold text-primary uppercase">Καταχώριση Σημείου</h1>
<button class="bg-primary text-white w-10 h-10 rounded-full flex items-center justify-center text-xl" id="openModalBtn">
        +
      </button>
</div>
</header>
<!-- Filters & Actions -->
<main class="w-full max-w-3xl px-4 space-y-4 mb-8">
<div class="flex justify-center">
<button class="px-4 py-1 bg-accent text-white rounded uppercase text-sm hover:bg-accent/90" id="refreshStigmaBtn">
        Ανανέωση Στίγματος
      </button>
</div><input class="border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-primary w-full lg:w-1/3" id="liveSearchInput" placeholder="Φίλτρο επωνυμίας..." type="text"/>
<div class="flex flex-col md:flex-row gap-2 justify-between items-center">
<div class="flex gap-2">
<button class="bg-indigo-500 text-white px-3 py-1 rounded uppercase text-xs hover:bg-indigo-600" id="routeBtn">
          Δρομολ. Περιοχής
        </button>
<button class="bg-teal-500 text-white px-3 py-1 rounded uppercase text-xs hover:bg-teal-600" id="customRouteBtn">
          Προσαρμ. Διαδρομή
        </button>
</div>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 justify-items-center" id="pointsContainer"></div>
<button class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-indigo-600 text-white px-4 py-1 rounded uppercase text-sm shadow-lg hover:bg-indigo-700 z-50" id="generateCustomRouteBtn">
<span class="absolute top-1 right-2 text-white text-lg cursor-pointer" id="cancelCustomBtn">✕</span>
      Δημιούργησε Διαδρομή
    </button>
</main>
<!-- Add Point Modal -->
<div class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center" id="modal">
<div class="bg-white rounded p-4 w-full max-w-sm relative">
<button class="absolute top-2 right-2 text-gray-600 text-xl" onclick="document.getElementById('modal').classList.add('opacity-0','pointer-events-none')">✕</button>
<h2 class="text-center uppercase mb-4 text-primary text-xl font-semibold">Καταχώριση Σημείου</h2>
<form class="space-y-4" id="pointForm">
<div>
<label class="block uppercase font-medium mb-1">Όνομα Σημείου</label>
<input class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-primary" id="pointName" required=""/>
</div>
<div>
<label class="block uppercase font-medium mb-1">Περιοχή</label>
<select class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-region" id="areaSelect" required="">
<option value="">Επιλέξτε...</option>
<option value="Πόλη">Πόλη</option>
<option value="Ιαλυσός">Ιαλυσός</option>
<option value="Φαληράκι">Φαληράκι</option>
<option value="Κολύμπια">Κολύμπια</option>
<option value="Νότια Ρόδος">Νότια Ρόδος</option>
<option value="Δυτική Ρόδος">Δυτική Ρόδος</option>
</select>
</div>
<div class="flex justify-end gap-2">
<button class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" id="cancelBtn" type="button">Ακύρωση</button>
<button class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90" type="submit">Καταχώριση</button>
</div>
</form>
</div>
</div>
<!-- Edit Point Modal -->
<div class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center" id="editModal">
<div class="bg-white rounded p-4 w-full max-w-sm relative">
<button class="absolute top-2 right-2 text-gray-600 text-xl" onclick="document.getElementById('editModal').classList.add('opacity-0','pointer-events-none')">✕</button>
<h2 class="text-center uppercase mb-4 text-primary text-xl font-semibold">Επεξεργασία Σημείου</h2>
<form class="space-y-4" id="editForm">
<div>
<label class="block uppercase font-medium mb-1">Όνομα Σημείου</label>
<input class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-primary" name="editName" required=""/>
</div>
<div>
<label class="block uppercase font-medium mb-1">Περιοχή</label>
<select class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-region" name="editArea" required="">
<option value="">Επιλέξτε...</option>
<option value="Πόλη">Πόλη</option>
<option value="Ιαλυσός">Ιαλυσός</option>
<option value="Φαληράκι">Φαληράκι</option>
<option value="Κολύμπια">Κολύμπια</option>
<option value="Νότια Ρόδος">Νότια Ρόδος</option>
<option value="Δυτική Ρόδος">Δυτική Ρόδος</option>
</select>
</div>
<div class="flex justify-end gap-2">
<button class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" id="editCancel" type="button">Ακύρωση</button>
<button class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90" type="submit">Αποθήκευση</button>
</div>
</form>
</div>
</div>
<!-- Route Modal -->
<div class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center" id="routeModal">
<div class="bg-white rounded p-4 w-full max-w-sm relative">
<button class="absolute top-2 right-2 text-gray-600 text-xl" onclick="document.getElementById('routeModal').classList.add('opacity-0','pointer-events-none')">✕</button>
<h2 class="text-center uppercase mb-4 text-primary text-xl font-semibold">Δρομολόγιο Περιοχής</h2>
<form class="space-y-4" id="routeForm">
<div>
<label class="block uppercase font-medium mb-1">Περιοχή</label>
<select class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-region" id="routeRegion" required="">
<option value="all">Όλες οι περιοχές</option>
<option value="Πόλη">Πόλη</option>
<option value="Ιαλυσός">Ιαλυσός</option>
<option value="Φαληράκι">Φαληράκι</option>
<option value="Κολύμπια">Κολύμπια</option>
<option value="Νότια Ρόδος">Νότια Ρόδος</option>
<option value="Δυτική Ρόδος">Δυτική Ρόδος</option>
</select>
</div>
<div>
<label class="block uppercase font-medium mb-1">Εύρος Ημερών</label>
<select class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-primary" id="routeDays">
<option value="all">Όλες</option>
<option value="lt3">Λιγότερο από 3</option>
<option value="3to7">3–7</option>
<option value="gt7">Πάνω από 7</option>
<option value="never">Ποτέ</option>
</select>
</div>
<p class="text-center text-gray-700 text-sm" id="routeCount"></p>
<div class="flex justify-end gap-2">
<button class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" id="routeCancel" type="button">Ακύρωση</button>
<button class="px-4 py-2 bg-success text-white rounded hover:bg-success/90" type="submit">Εξέλιξη</button>
</div>
</form>
</div>
</div>
<!-- Camera Modal -->
<div class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex flex-col items-center justify-center p-4" id="cameraModal">
<video autoplay="" class="w-full max-w-md rounded-lg mb-4" id="cameraVideo" playsinline=""></video>
<div class="flex gap-4">
<button class="bg-success text-white px-4 py-2 rounded" id="captureBtn">Τράβηγμα</button>
<button class="bg-danger text-white px-4 py-2 rounded" id="cancelCaptureBtn">Ακύρωση</button>
</div>
</div>
<!-- Photo Preview Modal -->
<div class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center p-4" id="photoModal">
<div class="bg-white rounded p-4 w-full max-w-sm relative">
<button class="absolute top-2 right-2 text-gray-600 text-xl" id="closePhotoModal">✕</button>
<img class="w-full h-auto rounded mb-2" id="photoImg"/>
<p class="text-center text-gray-600 text-xs mb-2" id="photoDate"></p>
<button class="block mx-auto bg-danger text-white px-3 py-1 rounded uppercase text-xs" id="deletePhotoBtn">
        Διαγραφή
      </button>
</div>
</div>
<!-- Hidden fallback file input -->
<input accept="image/*" capture="environment" id="photoInput" style="display:none" type="file"/>
<!-- Add Order Modal -->
<div class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center p-4" id="orderModal">
<div class="bg-white rounded-xl w-full max-w-xl modal-inner p-6 relative shadow-2xl">
<button class="absolute top-4 right-4 text-gray-600 text-2xl hover:text-gray-800" onclick="closeOrderModal()">✕</button>
<h2 class="text-3xl font-bold text-primary mb-6 text-center">Προσθήκη Παραγγελίας</h2>
<form class="space-y-6" id="orderForm">
<div class="space-y-4" id="orderItemsContainer"></div>
<div class="flex justify-between items-center">
<span class="text-xl font-medium">Σύνολο</span>
<span class="text-2xl font-extrabold" id="orderTotal">€0.00</span>
</div>
<div>
<label class="block font-medium mb-1">Παρατηρήσεις (προαιρετικό)</label>
<textarea class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-primary" id="orderRemarks" rows="3"></textarea>
</div>
<div class="text-center">
<button class="bg-success text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-success/90" type="submit">
            Αποστολή Παραγγελίας
          </button>
</div>
</form>
</div>
</div>
<script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey:    "AIzaSyDe966NdE-AW_eZrDCEKjw8y2h5mSdHr6o",
      authDomain:"pointregistrationapp.firebaseapp.com",
      projectId: "pointregistrationapp",
      storageBucket:"pointregistrationapp.appspot.com",
      messagingSenderId:"925139386507",
      appId:     "1:925139386507:web:588ae991f39a7bab04548e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(), storage = firebase.storage();

    // Helpers
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      const toRad = x => x * Math.PI / 180;
      const R = 6371;
      const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
                Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }
    function daysSince(ts) {
      return ts ? (new Date() - ts.toDate()) / (1000*60*60*24) : Infinity;
    }

    document.addEventListener("DOMContentLoaded", () => {
      let userLat, userLng, userLocationAllowed = false;
      let allPoints = [], editId, selectionMode = false, currentPhotoId, cameraStream;
      let currentPointId;

      // Elements
      const openBtn = document.getElementById("openModalBtn"),
            container = document.getElementById("pointsContainer"),
            refreshBtn = document.getElementById("refreshStigmaBtn"),
            cancelBtn = document.getElementById("cancelBtn"),
            form = document.getElementById("pointForm"),
            editModal = document.getElementById("editModal"),
            editCancel = document.getElementById("editCancel"),
            editForm = document.getElementById("editForm"),
            routeModal = document.getElementById("routeModal"),
            routeCancel = document.getElementById("routeCancel"),
            routeForm = document.getElementById("routeForm"),
            routeRegion = document.getElementById("routeRegion"),
            routeDays = document.getElementById("routeDays"),
            routeCount = document.getElementById("routeCount"),
            routeBtn = document.getElementById("routeBtn"),
            customBtn = document.getElementById("customRouteBtn"),
            genBtn = document.getElementById("generateCustomRouteBtn"),
            cancelGen = document.getElementById("cancelCustomBtn"),
            cameraModal = document.getElementById("cameraModal"),
            cameraVideo = document.getElementById("cameraVideo"),
            captureBtn = document.getElementById("captureBtn"),
            cancelCapture = document.getElementById("cancelCaptureBtn"),
            photoModal = document.getElementById("photoModal"),
            photoImg = document.getElementById("photoImg"),
            photoDate = document.getElementById("photoDate"),
            deletePhoto = document.getElementById("deletePhotoBtn"),
            closePhoto = document.getElementById("closePhotoModal"),
            photoInput = document.getElementById("photoInput"),
            orderModal = document.getElementById("orderModal"),
            orderForm = document.getElementById("orderForm"),
            itemsCont = document.getElementById("orderItemsContainer"),
            totalSpan = document.getElementById("orderTotal"),
            remarksIn = document.getElementById("orderRemarks");

      window.openOrderModal = openOrderModal;
      window.closeOrderModal = closeOrderModal;

      // Geolocation on load
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          userLat = pos.coords.latitude; userLng = pos.coords.longitude;
          userLocationAllowed = true; render();
        }, () => render(), { enableHighAccuracy: true, timeout: 10000 });
      } else render();

      // Refresh stigma
      refreshBtn.onclick = () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(pos => {
            userLat = pos.coords.latitude; userLng = pos.coords.longitude;
            userLocationAllowed = true; render();
          }, () => alert("Δεν μπορούμε να ανανεώσουμε τη θέση."), { enableHighAccuracy: true, timeout: 10000 });
        } else alert("Το Geolocation δεν υποστηρίζεται.");
      };

      // Add Point
      openBtn.onclick = () => navigator.geolocation.getCurrentPosition(pos => {
        window._tempLat = pos.coords.latitude; window._tempLng = pos.coords.longitude;
        document.getElementById('modal').classList.remove('opacity-0','pointer-events-none');
      }, () => alert("Άδεια τοποθεσίας απαραίτητη."));

      cancelBtn.onclick = () => {
        document.getElementById('modal').classList.add('opacity-0','pointer-events-none');
        form.reset();
      };

      form.onsubmit = async e => {
        e.preventDefault();
        const name = form.pointName.value.trim(),
              area = form.areaSelect.value,
              lat  = window._tempLat,
              lng  = window._tempLng;
        if (!name || !area || lat===undefined || lng===undefined) return alert("Συμπληρώστε όλα τα πεδία.");
        await db.collection("points").add({
          name, area, latitude:lat, longitude:lng,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        cancelBtn.click();
      };

      // Edit Point
      editCancel.onclick = () => {
        editModal.classList.add("opacity-0","pointer-events-none");
        editForm.reset();
      };
      editForm.onsubmit = async e => {
        e.preventDefault();
        const name = editForm.editName.value.trim(),
              area = editForm.editArea.value;
        if (!name || !area) return alert("Συμπληρώστε όλα τα πεδία.");
        await db.collection("points").doc(editId).update({ name, area });
        editCancel.click();
      };

      // Route by area
      routeBtn.onclick = () => {
        routeModal.classList.remove("opacity-0","pointer-events-none");
        updateRouteCount();
      };
      routeCancel.onclick = () => {
        routeModal.classList.add("opacity-0","pointer-events-none");
        routeForm.reset();
        routeCount.textContent = "";
      };
      routeForm.onsubmit = e => {
        e.preventDefault();
        const sel = routeRegion.value, days = routeDays.value;
        let pts = allPoints.filter(p => sel==='all'||p.area===sel)
          .filter(p => {
            const age = daysSince(p.lastVisit||0);
            if (days==='lt3') return age<3;
            if (days==='3to7') return age>=3&&age<=7;
            if (days==='gt7') return age>7;
            if (days==='never') return !p.lastVisit;
            return true;
          });
        if (pts.length < 2) return alert("Ελάχιστα 2 σημεία.");
        pts.sort((a,b)=>a.timestamp.seconds-b.timestamp.seconds);
        const coords = pts.map(p=>`${p.latitude},${p.longitude}`),
              o = coords.shift(),
              d = coords.pop(),
              w = coords.join("|");
        let url = `https://www.google.com/maps/dir/?api=1&origin=${o}&destination=${d}`;
        if (w) url += `&waypoints=${w}`;
        window.open(url,"_blank");
        routeCancel.click();
      };
      routeRegion.onchange = updateRouteCount;
      routeDays.onchange = updateRouteCount;
      function updateRouteCount(){
        const sel = routeRegion.value, days = routeDays.value;
        const cnt = allPoints.filter(p => sel==='all'||p.area===sel)
          .filter(p => {
            const age = daysSince(p.lastVisit||0);
            if (days==='lt3') return age<3;
            if (days==='3to7') return age>=3&&age<=7;
            if (days==='gt7') return age>7;
            if (days==='never') return !p.lastVisit;
            return true;
          }).length;
        routeCount.textContent = `Βρέθηκαν ${cnt} σημεία`;
      }

      // Custom Route
      customBtn.onclick = () => {
        selectionMode = true;
        genBtn.classList.remove("hidden");
        cancelGen.classList.remove("hidden");
        render();
      };
      cancelGen.onclick = e => {
        e.stopPropagation();
        selectionMode = false;
        genBtn.classList.add("hidden");
        cancelGen.classList.add("hidden");
        render();
      };
      genBtn.onclick = () => {
        const checked = [...container.querySelectorAll("input[type=checkbox]:checked")];
        if (!checked.length) return alert("Επιλέξτε σημεία.");
        const coords = checked.map(cb => {
          const p = allPoints.find(x=>x.id===cb.dataset.id);
          return `${p.latitude},${p.longitude}`;
        });
        const o = coords.shift(), d = coords.pop(), w = coords.join("|");
        let url = `https://www.google.com/maps/dir/?api=1&origin=${o}&destination=${d}`;
        if (w) url += `&waypoints=${w}`;
        window.open(url,"_blank");
        cancelGen.click();
      };

      // Photo / Camera logic
      function showPhoto(id){
        currentPhotoId = id;
        db.collection("points").doc(id).get().then(doc=>{
          const data = doc.data()||{};
          if (data.photoURL){
            photoImg.src = data.photoURL;
            photoDate.textContent = new Date(data.photoTimestamp.toDate()).toLocaleString();
            photoModal.classList.remove("opacity-0","pointer-events-none");
          } else {
            if (navigator.mediaDevices?.getUserMedia){
              cameraModal.classList.remove("opacity-0","pointer-events-none");
              navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}})
                .then(stream=>{ cameraStream=stream; cameraVideo.srcObject=stream; })
                .catch(()=>photoInput.click());
            } else {
              photoInput.click();
            }
          }
        }).catch(err=>{
          alert("Σφάλμα ανάκτησης φωτογραφίας: "+err.message);
        });
      }
      captureBtn.onclick = ()=>{
        if (!cameraVideo?.videoWidth) return;
        const canvas = document.createElement('canvas');
        canvas.width = cameraVideo.videoWidth;
        canvas.height = cameraVideo.videoHeight;
        canvas.getContext('2d').drawImage(cameraVideo,0,0);
        cameraStream.getTracks().forEach(t=>t.stop());
        cameraModal.classList.add("opacity-0","pointer-events-none");
        if (!confirm("Θέλεις να αποθηκεύσεις τη φωτογραφία;")) return;
        canvas.toBlob(async blob=>{
          try{
            const ref = storage.ref(`points/${currentPhotoId}.jpg`);
            const snap = await ref.put(blob);
            const url = await ref.getDownloadURL();
            const ts = firebase.firestore.FieldValue.serverTimestamp();
            await db.collection("points").doc(currentPhotoId).update({ photoURL:url, photoTimestamp:ts });
            photoImg.src = url;
            photoDate.textContent = new Date().toLocaleString();
            photoModal.classList.remove("opacity-0","pointer-events-none");
          } catch(err){
            alert("Σφάλμα upload: "+err.message);
          }
        }, 'image/jpeg', 0.8);
      };
      cancelCapture.onclick = ()=>{
        cameraStream?.getTracks().forEach(t=>t.stop());
        cameraModal.classList.add("opacity-0","pointer-events-none");
      };
      photoInput.onchange = async ()=>{
        const file = photoInput.files[0];
        if (!file || !currentPhotoId || !confirm("Θέλεις να αποθηκεύσεις τη φωτογραφία;")) return;
        try{
          const ref = storage.ref(`points/${currentPhotoId}.jpg`);
          await ref.put(file);
          const url = await ref.getDownloadURL();
          const ts = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection("points").doc(currentPhotoId).update({ photoURL:url, photoTimestamp:ts });
          photoImg.src = url;
          photoDate.textContent = new Date().toLocaleString();
          photoModal.classList.remove("opacity-0","pointer-events-none");
        } catch(err){
          alert("Σφάλμα upload (fallback): "+err.message);
        }
      };
      deletePhoto.onclick = async ()=>{
        if (!currentPhotoId || !confirm("Θέλεις να διαγράψεις τη φωτογραφία;")) return;
        try{
          await storage.ref(`points/${currentPhotoId}.jpg`).delete();
          await db.collection("points").doc(currentPhotoId).update({
            photoURL: firebase.firestore.FieldValue.delete(),
            photoTimestamp: firebase.firestore.FieldValue.delete()
          });
          photoModal.classList.add("opacity-0","pointer-events-none");
        } catch(err){
          alert("Σφάλμα διαγραφής: "+err.message);
        }
      };
      closePhoto.onclick = ()=> photoModal.classList.add("opacity-0","pointer-events-none");

      // Order modal functions
      function openOrderModal(pointId){
        currentPointId = pointId;
        itemsCont.innerHTML = '';
        totalSpan.textContent = '€0.00';
        remarksIn.value = '';
        db.collection('products').get().then(snap=>{
          snap.docs.forEach(doc=>{
            const {name, price} = doc.data();
            const row = document.createElement('div');
            row.className = 'flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 p-3 bg-gray-50 rounded-lg shadow-inner';
            const spanName = document.createElement('span');
            spanName.className = 'flex-1 text-lg font-medium';
            spanName.textContent = name;
            row.appendChild(spanName);
            const ctrl = document.createElement('div');
            ctrl.className = 'flex items-center gap-2';
            const input = document.createElement('input');
            input.type = 'number'; input.min='0'; input.value='0';
            input.dataset.id = doc.id; input.dataset.price = price;
            input.className = 'w-16 border rounded-lg px-2 py-1 text-center focus:ring-2 focus:ring-accent';
            input.addEventListener('input', updateOrderTotal);
            [1,3,5].forEach(delta=>{
              const btn = document.createElement('button');
              btn.type='button';
              btn.className = 'bg-primary text-white px-2 py-1 rounded-lg hover:bg-primary/90 text-sm';
              btn.textContent = `+${delta}`;
              btn.addEventListener('click', ()=>{
                input.value = Math.max(0, (parseInt(input.value)||0) + delta);
                updateOrderTotal();
              });
              ctrl.appendChild(btn);
            });
            ctrl.appendChild(input);
            const spanPrice = document.createElement('span');
            spanPrice.className = 'w-20 text-right text-sm text-gray-600';
            spanPrice.textContent = `€${price.toFixed(2)}`;
            ctrl.appendChild(spanPrice);
            const spanSub = document.createElement('span');
            spanSub.className = 'w-24 text-right font-semibold item-subtotal';
            spanSub.textContent = '€0.00';
            ctrl.appendChild(spanSub);
            row.appendChild(ctrl);
            itemsCont.appendChild(row);
          });
        });
        orderModal.classList.remove('opacity-0','pointer-events-none');
      }
      function closeOrderModal(){
        orderModal.classList.add('opacity-0','pointer-events-none');
      }
      function updateOrderTotal(){
        let total = 0;
        document.querySelectorAll('#orderItemsContainer > div').forEach(row=>{
          const inp = row.querySelector('input'),
                qty = parseInt(inp.value)||0,
                price = parseFloat(inp.dataset.price),
                st = qty*price;
          row.querySelector('.item-subtotal').textContent = `€${st.toFixed(2)}`;
          total += st;
        });
        totalSpan.textContent = `€${total.toFixed(2)}`;
      }

      // HERE is the FIX: use for…of + await instead of forEach
      orderForm.onsubmit = async e=>{
        e.preventDefault();
        const total   = parseFloat(totalSpan.textContent.replace('€','')),
              remarks = remarksIn.value.trim();
        const orderRef = await db.collection('points').doc(currentPointId)
                                .collection('orders').add({
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          total, remarks
        });
        const rows = Array.from(document.querySelectorAll('#orderItemsContainer > div'));
        for (let row of rows) {
          const inp = row.querySelector('input'),
                qty = parseInt(inp.value) || 0;
          if (qty > 0) {
            const pid   = inp.dataset.id,
                  price = parseFloat(inp.dataset.price);
            await orderRef.collection('items').add({
              productId: db.doc(`products/${pid}`),
              quantity: qty,
              price,
              subtotal: qty * price
            });
          }
        }
        closeOrderModal();
        alert('Η παραγγελία καταχωρήθηκε!');
      };

      // Firestore listener & render
      db.collection("points").orderBy("timestamp","desc")
        .onSnapshot(snap=>{
          allPoints = snap.docs.map(d=>({id:d.id, ...d.data()}));
          render();
        });

      
      function render() {
        container.innerHTML = '';
        if (userLocationAllowed && userLat != null && userLng != null) {
          // Compute distances and sort
          const ptsWithDist = allPoints.map(pt => {
            if (pt.latitude != null && pt.longitude != null) {
              const dist = getDistanceFromLatLonInKm(userLat, userLng, pt.latitude, pt.longitude);
              return { pt: pt, dist: dist };
            } else {
              return { pt: pt, dist: null };
            }
          });
          ptsWithDist.sort((a, b) => {
            if (a.dist === null && b.dist === null) return 0;
            if (a.dist === null) return 1;
            if (b.dist === null) return -1;
            return a.dist - b.dist;
          });
          ptsWithDist.forEach(item => {
            container.append(card(item.pt, item.dist));
          });
        } else {
          // No location: render in existing order
          allPoints.forEach(pt => {
            container.append(card(pt, null));
          });
        }
      }
      function card(pt, distKm) {
        const c = document.createElement("div");
        // Highlight if within threshold (e.g., 0.5 km)
        const AUTO_RADIUS_KM = 0.5;
        let classes = "relative bg-white rounded-xl p-4 shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition overflow-hidden";
        if (distKm !== null && distKm <= AUTO_RADIUS_KM) {
          // Add highlight styles
          classes += " border-2 border-success bg-green-50";
        }
        c.className = classes;
        // Area badge
        const ab = document.createElement("div");
        ab.className = "absolute top-2 left-1/2 transform -translate-x-1/2 bg-region text-white px-2 py-0.5 rounded-full text-xs uppercase";
        ab.textContent = pt.area;
        c.append(ab);
        // Name with distance if available
        const h3 = document.createElement("h3");
        h3.className = "mt-6 text-center text-lg font-bold uppercase text-darktext break-words";
        let nameText = pt.name;
        if (distKm !== null) {
          nameText += " (" + distKm.toFixed(2) + " km)";
        }
        h3.textContent = nameText;
        c.append(h3);
        // Age and buttons
        const row = document.createElement("div");
        row.className = "mt-4 flex justify-between items-center";
        const ageDiv = document.createElement("div");
        const age = daysSince(pt.lastVisit || 0);
        const dc = age===Infinity||age>7?"bg-danger animate-pulse":age>3?"bg-accent animate-ping":"bg-success";
        ageDiv.innerHTML = `<span class="${dc} inline-block w-2 h-2 rounded-full"></span>
                            <span class="text-xs text-gray-500 uppercase ml-1">
                              ${age===Infinity?"Ποτέ":Math.floor(age)===1?"1 ημέρα":`${Math.floor(age)} ημέρες`}
                            </span>`;
        row.append(ageDiv);
        const btns = document.createElement("div");
        btns.className = "flex gap-1";
        ["Επίσκεψη","Αλλαγή","Διαγραφή","Προβολή"].forEach(lbl=>{
          const b = document.createElement("button");
          b.className = "px-2 py-1 text-xs rounded text-white "+
                        (lbl==="Επίσκεψη"?"bg-success":lbl==="Αλλαγή"?"bg-accent":lbl==="Διαγραφή"?"bg-danger":"bg-region");
          b.textContent = lbl;
          b.onclick = {
            "Επίσκεψη": async ()=>{
              const now = new Date();
              await db.collection("points").doc(pt.id)
                       .update({ lastVisit: firebase.firestore.FieldValue.serverTimestamp() });
              pt.lastVisit = { toDate: ()=>now };
              render();
            },
            "Αλλαγή": ()=>{
              editId = pt.id;
              document.querySelector("#editForm input[name=editName]").value = pt.name;
              document.querySelector("#editForm select[name=editArea]").value = pt.area;
              editModal.classList.remove("opacity-0","pointer-events-none");
            },
            "Διαγραφή": async ()=>{
              if (confirm("Διαγραφή;")) await db.collection("points").doc(pt.id).delete();
            },
            "Προβολή": ()=> showPhoto(pt.id)
          }[lbl];
          btns.append(b);
        });
        row.append(btns);
        c.append(row);
        if (pt.lastVisit){
          const p = document.createElement("p");
          p.className = "text-xs text-gray-500 italic mt-2 text-center";
          p.textContent = "Τελευταία επίσκεψη: "+pt.lastVisit.toDate().toLocaleString();
          c.append(p);
        }
        const addOrderBtn = document.createElement("button");
        addOrderBtn.textContent = "Προσθήκη Παραγγελίας";
        addOrderBtn.className = "block w-full mt-2 bg-accent text-white py-1 rounded uppercase text-xs hover:bg-accent/90";
        addOrderBtn.onclick = ()=> openOrderModal(pt.id);
        c.append(addOrderBtn);
        const a = document.createElement("a");
        a.href = `https://www.google.com/maps/search/?api=1&query=${pt.latitude},${pt.longitude}`;
        a.target = "_blank";
        a.className = "block text-center bg-primary text-white py-1 rounded uppercase text-xs mt-2 hover:bg-primary/90";
        a.textContent = "Χάρτης";
        c.append(a);
        if (selectionMode){
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.dataset.id = pt.id;
          cb.className = "absolute top-2 right-1 form-checkbox h-4 w-4 text-primary";
          c.append(cb);
        }
        return c;
      }

    });
  </script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var liveInput = document.getElementById('liveSearchInput');
  var container = document.getElementById('pointsContainer');
  if (liveInput && container) {
    liveInput.addEventListener('input', function() {
      var filter = this.value.trim().toLowerCase();
      container.querySelectorAll('.client-card, .bg-white').forEach(function(card) {
        var nameEl = card.querySelector('h3');
        var name = nameEl ? nameEl.textContent.toLowerCase() : '';
        card.style.display = name.includes(filter) ? '' : 'none';
      });
    });
  }
});
</script></body></html>
