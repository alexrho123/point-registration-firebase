<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Καταχώριση Σημείου (Firebase)</title>
  <!-- Tailwind CSS + custom colors -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: {
        colors: { primary:'#1E3A8A', accent:'#FBBF24', danger:'#DC2626', success:'#16A34A' }
      }}
    }
  </script>
  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDe966NdE-AW_eZrDCEKjw8y2h5mSdHr6o",
      authDomain: "pointregistrationapp.firebaseapp.com",
      projectId: "pointregistrationapp",
      storageBucket: "pointregistrationapp.firebasestorage.app",
      messagingSenderId: "925139386507",
      appId: "1:925139386507:web:588ae991f39a7bab04548e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function daysSince(ts) {
      if (!ts) return Infinity;
      const d = ts.toDate(), now = new Date();
      return (now - d) / (1000*60*60*24);
    }

    document.addEventListener("DOMContentLoaded", () => {
      let userLat, userLng, allPoints = [], editId = null, selectionMode = false;
      const openBtn     = document.getElementById("openModalBtn"),
            addModal    = document.getElementById("modal"),
            cancelBtn   = document.getElementById("cancelBtn"),
            form        = document.getElementById("pointForm"),
            editModal   = document.getElementById("editModal"),
            editCancel  = document.getElementById("editCancel"),
            editForm    = document.getElementById("editForm"),
            routeBtn    = document.getElementById("routeBtn"),
            customBtn   = document.getElementById("customRouteBtn"),
            generateBtn = document.getElementById("generateCustomRouteBtn"),
            container   = document.getElementById("pointsContainer"),
            regionF     = document.getElementById("regionFilter"),
            visitedF    = document.getElementById("visitedFilter");

      // fetch and render
      db.collection("points").orderBy("timestamp","desc")
        .onSnapshot(snap => {
          allPoints = snap.docs.map(d=>({ id:d.id, ...d.data() }));
          render();
        });

      // Add Modal
      openBtn.onclick = () => {
        if (!navigator.geolocation) return alert("Δεν υποστηρίζεται γεωεντοπισμός.");
        navigator.geolocation.getCurrentPosition(pos => {
          userLat = pos.coords.latitude; userLng = pos.coords.longitude;
          addModal.classList.remove("opacity-0","pointer-events-none");
        }, ()=> alert("Άδεια τοποθεσίας απαραίτητη."));
      };
      cancelBtn.onclick = () => {
        addModal.classList.add("opacity-0","pointer-events-none");
        form.reset();
      };
      form.onsubmit = async e => {
        e.preventDefault();
        const n = form.pointName.value.trim(), a = form.areaSelect.value;
        if (!n||!a) return alert("Συμπληρώστε όλα τα πεδία.");
        await db.collection("points").add({
          name:n, area:a,
          latitude:userLat, longitude:userLng,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        cancelBtn.click();
      };

      // Edit Modal
      editCancel.onclick = () => {
        editModal.classList.add("opacity-0","pointer-events-none");
        editForm.reset();
      };
      editForm.onsubmit = async e => {
        e.preventDefault();
        const n = editForm.editName.value.trim(), a = editForm.editArea.value;
        if (!n||!a) return alert("Συμπληρώστε όλα τα πεδία.");
        await db.collection("points").doc(editId).update({ name:n, area:a });
        editCancel.click();
      };

      // Route Modal (existing)...

      // Custom Route Button
      customBtn.onclick = () => {
        selectionMode = true;
        generateBtn.classList.remove("hidden");
        render();
      };

      // Generate Custom Route
      generateBtn.onclick = () => {
        const checkboxes = container.querySelectorAll("input[type=checkbox]:checked");
        if (checkboxes.length === 0) {
          alert("Επιλέξτε τουλάχιστον ένα σημείο.");
          return;
        }
        const coords = [];
        checkboxes.forEach(cb => {
          const pt = allPoints.find(p=>p.id===cb.dataset.id);
          coords.push(`${pt.latitude},${pt.longitude}`);
        });
        const origin = `${userLat},${userLng}`;
        const destination = coords.pop();
        const waypoints = coords.join("|");
        let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;
        if (waypoints) url += `&waypoints=${waypoints}`;
        window.open(url,"_blank");
        // reset
        selectionMode = false;
        generateBtn.classList.add("hidden");
        render();
      };

      regionF.onchange  = render;
      visitedF.onchange = render;

      function render() {
        container.innerHTML = "";
        const sel = regionF.value, vis = visitedF.value;
        allPoints.forEach(pt => {
          const visited = !!pt.lastVisit;
          const okArea  = !sel || pt.area===sel;
          const okVis   = vis==='all' || (vis==='visited' && visited) || (vis==='unvisited' && !visited);
          if (okArea && okVis) container.appendChild(makeCard(pt));
        });
      }

      function makeCard(pt) {
        const c = document.createElement("div");
        c.className = "relative bg-white rounded-2xl p-6 shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition";
        // area badge
        const badge = document.createElement("div");
        badge.className = "absolute top-3 left-3 bg-primary text-white px-2 py-1 rounded-full text-xs uppercase";
        badge.textContent = pt.area;
        c.appendChild(badge);

        // header
        const h = document.createElement("div");
        h.className = "flex items-center justify-between";

        // left: indicator + days + title
        const left = document.createElement("div");
        left.className = "flex items-center gap-4";

        const age = daysSince(pt.lastVisit);
        let dotClass = age===Infinity||age>7 ? "bg-danger animate-pulse"
                       : age>3          ? "bg-accent animate-ping"
                                        : "bg-success";
        const dot = document.createElement("span");
        dot.className = `w-3 h-3 ${dotClass} rounded-full`;

        let label = age===Infinity ?"Ποτέ"
                  : Math.floor(age)===1 ?"1 ημέρα"
                  : `${Math.floor(age)} ημέρες`;
        const lbl = document.createElement("span");
        lbl.className = "text-sm text-gray-500 uppercase";
        lbl.textContent = label;

        const title = document.createElement("h3");
        title.className = "text-xl font-bold uppercase text-primary";
        title.textContent = pt.name;

        left.append(dot, lbl, title);
        h.appendChild(left);

        // right: check / visit / edit / delete
        const right = document.createElement("div");
        right.className = "flex items-center gap-2";

        if (selectionMode) {
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.className = "form-checkbox h-5 w-5 text-primary";
          cb.dataset.id = pt.id;
          right.append(cb);
        }

        const vbtn = document.createElement("button");
        vbtn.className = "px-3 py-1 bg-accent text-white rounded-full uppercase text-sm";
        vbtn.textContent = "Επίσκεψη";
        if (daysSince(pt.lastVisit)<1) {
          vbtn.disabled = true;
          vbtn.classList.add("opacity-50");
        }
        vbtn.onclick = async () => {
          const now = new Date();
          await db.collection("points").doc(pt.id)
            .update({ lastVisit: firebase.firestore.FieldValue.serverTimestamp() });
          pt.lastVisit = { toDate:()=>now };
          render();
        };
        right.append(vbtn);

        const editBtn = document.createElement("button");
        editBtn.className = "px-3 py-1 bg-primary text-white rounded-full uppercase text-sm";
        editBtn.textContent = "Αλλαγή";
        editBtn.onclick = () => {
          editId = pt.id;
          editForm.editName.value = pt.name;
          editForm.editArea.value = pt.area;
          editModal.classList.remove("opacity-0","pointer-events-none");
        };
        right.append(editBtn);

        const dbtn = document.createElement("button");
        dbtn.className = "px-3 py-1 bg-danger text-white rounded-full uppercase text-sm";
        dbtn.textContent = "Διαγραφή";
        dbtn.onclick = async () => {
          if (confirm("Διαγραφή;")) await db.collection("points").doc(pt.id).delete();
        };
        right.append(dbtn);

        h.appendChild(right);
        c.appendChild(h);

        // last visit info
        if (pt.lastVisit) {
          const p = document.createElement("p");
          p.className = "text-gray-500 italic text-sm mt-2";
          p.textContent = "Τελευταία επίσκεψη: "+pt.lastVisit.toDate().toLocaleString();
          c.appendChild(p);
        }

        // map link
        const m = document.createElement("a");
        m.href = `https://www.google.com/maps/search/?api=1&query=${pt.latitude},${pt.longitude}`;
        m.target = "_blank";
        m.className = "block text-center bg-primary text-white py-2 rounded-lg uppercase font-semibold hover:bg-primary/90 transition mt-2";
        m.textContent = "Δείτε στον χάρτη";
        c.appendChild(m);

        return c;
      }
    });
  </script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-12">

  <!-- Header -->
  <header class="w-full bg-white shadow-md py-4 mb-8">
    <div class="max-w-3xl mx-auto px-6 flex justify-between items-center">
      <h1 class="text-3xl font-extrabold text-primary uppercase">Καταχώριση Σημείου</h1>
      <button id="openModalBtn" class="bg-primary text-white w-14 h-14 rounded-full flex items-center justify-center text-3xl shadow-lg hover:bg-primary/90 transition transform hover:scale-110">+</button>
    </div>
  </header>

  <main class="w-full max-w-3xl px-4 space-y-6 mb-10">
    <div class="flex justify-center gap-4">
      <a href="http://treno2025.unaux.com/" target="_blank" class="px-6 py-2 bg-primary text-white rounded-full uppercase font-semibold shadow hover:bg-primary/90 transition">Μετάβαση στις Παραγγελίες</a>
      <button id="customRouteBtn" class="px-6 py-2 bg-indigo-600 text-white rounded-full uppercase font-semibold shadow hover:bg-indigo-700 transition">Κάνε το δικό σου Δρομολόγιο</button>
    </div>
    <div class="flex flex-col sm:flex-row gap-4 justify-between items-center">
      <select id="regionFilter" class="flex-1 border border-gray-300 px-3 py-2 rounded-lg uppercase shadow focus:outline-none">
        <option value="">Όλες οι περιοχές</option>
        <option value="Πόλη">Πόλη</option>
        <option value="Ιαλυσός">Ιαλυσός</option>
        <option value="Φαληράκι">Φαληράκι</option>
        <option value="Κολύμπια">Κολύμπια</option>
        <option value="Νότια Ρόδος">Νότια Ρόδος</option>
        <option value="Δυτική Ρόδος">Δυτική Ρόδος</option>
      </select>
      <select id="visitedFilter" class="border border-gray-300 px-3 py-2 rounded-lg uppercase shadow focus:outline-none">
        <option value="all">Όλες</option>
        <option value="visited">Επισκεφθείσες</option>
        <option value="unvisited">Μη Επισκεφθείσες</option>
      </select>
      <button id="routeBtn" class="bg-success text-white px-6 py-2 rounded-lg uppercase shadow hover:bg-success/90 transition">Δρομολόγιο Περιοχής</button>
    </div>
    <div id="pointsContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-6"></div>
    <button id="generateCustomRouteBtn" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-success text-white px-6 py-3 rounded-lg uppercase font-semibold shadow-lg hover:bg-success/90 transition">Δημιούργησε Διαδρομή</button>
  </main>

  <!-- Add Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center transition-opacity">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-lg transform scale-95 transition-transform">
      <h2 class="text-center uppercase mb-4">Καταχώριση Σημείου</h2>
      <form id="pointForm" class="space-y-4">
        <div>
          <label class="block uppercase font-medium mb-1">Όνομα Σημείου</label>
          <input id="pointName" class="w-full border px-3 py-2 rounded-lg uppercase focus:outline-none focus:ring-2 focus:ring-primary" required />
        </div>
        <div>
          <label class="block uppercase font-medium mb-1">Περιοχή</label>
          <select id="areaSelect" class="w-full border px-3 py-2 rounded-lg uppercase focus:outline-none focus:ring-2 focus:ring-primary" required>
            <option value="">Επιλέξτε...</option>
            <option value="Πόλη">Πόλη</option>
            <option value="Ιαλυσός">Ιαλυσός</option>
            <option value="Φαληράκι">Φαληράκι</option>
            <option value="Κολύμπια">Κολύμπια</option>
            <option value="Νότια Ρόδος">Νότια Ρόδος</option>
            <option value="Δυτική Ρόδος">Δυτική Ρόδος</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-300 uppercase rounded-lg">Ακύρωση</button>
          <button type="submit" class="px-4 py-2 bg-primary text-white uppercase rounded-lg">Καταχώριση</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center transition-opacity">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-lg transform scale-95 transition-transform">
      <h2 class="text-center uppercase mb-4">Επεξεργασία Σημείου</h2>
      <form id="editForm" class="space-y-4">
        <div>
          <label class="block uppercase font-medium mb-1">Όνομα Σημείου</label>
          <input name="editName" class="w-full border px-3 py-2 rounded-lg uppercase focus:outline-none focus:ring-2 focus:ring-primary" required />
        </div>
        <div>
          <label class="block uppercase font-medium mb-1">Περιοχή</label>
          <select name="editArea" class="w-full border px-3 py-2 rounded-lg uppercase focus:outline-none focus:ring-2 focus:ring-primary" required>
            <option value="">Επιλέξτε...</option>
            <option value="Πόλη">Πόλη</option>
            <option value="Ιαλυσός">Ιαλυσός</option>
            <option value="Φαληράκι">Φαληράκι</option>
            <option value="Κολύμπια">Κολύμπια</option>
            <option value="Νότια Ρόδος">Νότια Ρόδος</option>
            <option value="Δυτική Ρόδος">Δυτική Ρόδος</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="editCancel" class="px-4 py-2 bg-gray-300 uppercase rounded-lg">Ακύρωση</button>
          <button type="submit" class="px-4 py-2 bg-primary text-white uppercase rounded-lg">Αποθήκευση</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Route Modal -->
  <div id="routeModal" class="fixed inset-0 bg-black bg-opacity-60 opacity-0 pointer-events-none flex items-center justify-center transition-opacity">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-lg transform scale-95 transition-transform">
      <h2 class="text-center uppercase mb-4">Δρομολόγιο Περιοχής</h2>
      <form id="routeForm" class="space-y-4">
        <div>
          <label class="block uppercase font-medium mb-1">Περιοχή</label>
          <select id="routeRegion" class="w-full border px-3 py-2 rounded-lg uppercase focus:outline-none focus:ring-2 focus:ring-primary" required>
            <option value="all">Όλες οι περιοχές</option>
            <option value="Πόλη">Πόλη</option>
            <option value="Ιαλυσός">Ιαλυσός</option>
            <option value="Φαληράκι">Φαληράκι</option>
            <option value="Κολύμπια">Κολύμπια</option>
            <option value="Νότια Ρόδος">Νότια Ρόδος</option>
            <option value="Δυτική Ρόδος">Δυτική Ρόδος</option>
          </select>
        </div>
        <div>
          <label class="block uppercase font-medium mb-1">Εύρος Ημερών</label>
          <select id="routeDays" class="w-full border px-3 py-2 rounded-lg uppercase focus:outline-none focus:ring-2 focus:ring-primary">
            <option value="all">Όλες</option>
            <option value="lt3">Λιγότερο από 3</option>
            <option value="3to7">3–7</option>
            <option value="gt7">Πάνω από 7</option>
            <option value="never">Ποτέ</option>
          </select>
        </div>
        <p id="routeCount" class="text-center text-gray-700 font-medium"></p>
        <div class="flex justify-end gap-2">
          <button type="button" id="routeCancel" class="px-4 py-2 bg-gray-300 uppercase rounded-lg">Ακύρωση</button>
          <button type="submit" class="px-4 py-2 bg-success text-white uppercase rounded-lg">Εξέλιξη</button>
        </div>
      </form>
    </div>
  </div>
</body>
</html>
