<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Î Î¯Î½Î±ÎºÎ±Ï‚ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
        extend: {
          colors: {
            primary: '#4f46e5', accent: '#f59e0b',
            danger: '#dc2626', success: '#16a34a',
            softbg: '#f8fafc'
          }
        }
      }
    };
  </script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-softbg font-sans text-gray-800 min-h-screen flex flex-col items-center">

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black/50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 shadow-lg w-full max-w-sm">
      <h2 class="text-2xl font-bold text-primary mb-4 text-center">Î£ÏÎ½Î´ÎµÏƒÎ· Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®</h2>
      <form id="loginForm" class="space-y-4">
        <input id="loginUsername" type="text" placeholder="Username" required
               class="w-full px-4 py-2 border rounded"/>
        <input id="loginPassword" type="password" placeholder="Password" required
               class="w-full px-4 py-2 border rounded"/>
        <button type="submit" class="w-full bg-primary text-white py-2 rounded">Î£ÏÎ½Î´ÎµÏƒÎ·</button>
      </form>
    </div>
  </div>

  <!-- Main App -->
  <div id="appContent" class="hidden w-full max-w-5xl flex flex-col flex-1">

    <!-- Navbar -->
    <nav class="w-full bg-white shadow px-6 py-4 flex justify-between items-center">
      <h1 class="text-3xl font-bold text-primary">Î Î¯Î½Î±ÎºÎ±Ï‚ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚</h1>
      <button id="logoutBtn" class="bg-danger text-white px-4 py-2 rounded">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</button>
    </nav>

    <!-- Tabs -->
    <div class="bg-white w-full px-6">
      <ul id="tabs" class="flex space-x-6 border-b">
        <li data-tab="users" class="py-2 cursor-pointer hover:text-primary">Î§ÏÎ®ÏƒÏ„ÎµÏ‚</li>
        <li data-tab="products" class="py-2 cursor-pointer hover:text-primary">Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±</li>
        <li data-tab="points" class="py-2 cursor-pointer hover:text-primary">Î£Î·Î¼ÎµÎ¯Î±</li>
        <li data-tab="orders" class="py-2 cursor-pointer hover:text-primary">Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚</li>
      </ul>
    </div>

    <!-- Content -->
    <main class="flex-1 overflow-auto p-6">

      <!-- Users Tab -->
      <section id="users" class="tab-content hidden">
        <button id="addUserBtn" class="mb-4 bg-success text-white px-4 py-2 rounded">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î§ÏÎ®ÏƒÏ„Î·</button>
        <div id="usersContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>

      <!-- Products Tab -->
      <section id="products" class="tab-content hidden">
        <button id="addProductBtn" class="mb-4 bg-success text-white px-4 py-2 rounded">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚</button>
        <div id="productsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>

      <!-- Points Tab -->
      <section id="points" class="tab-content hidden">
        <div id="pointsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>

      <!-- Orders Tab -->
      <section id="orders" class="tab-content hidden">
        <button id="refreshOrdersBtn" class="mb-4 bg-accent text-white px-4 py-2 rounded">Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button>
        <table class="w-full bg-white rounded-xl shadow overflow-hidden text-center">
          <thead class="bg-primary text-white">
            <tr>
              <th class="px-4 py-2">Î£Î·Î¼ÎµÎ¯Î¿</th>
              <th class="px-4 py-2">Î£ÏÎ½Î¿Î»Î¿ (â‚¬)</th>
              <th class="px-4 py-2">ÎÏÎ±</th>
              <th class="px-4 py-2">Î”Î¹Î±Î³Ï.</th>
              <th class="px-4 py-2">Î•Ï€ÎµÎ¾.</th>
              <th class="px-4 py-2">ÎŸÎ»Î¿ÎºÎ».</th>
            </tr>
          </thead>
          <tbody id="ordersTable"></tbody>
        </table>
      </section>

    </main>
  </div>

  <!-- User Modal -->
  <div id="userModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
    <div class="bg-white rounded-xl p-6 shadow-lg w-full max-w-md">
      <h3 class="text-xl font-semibold mb-4">ÎÎ­Î¿Ï‚ Î§ÏÎ®ÏƒÏ„Î·Ï‚</h3>
      <form id="userForm" class="space-y-3">
        <input id="userName" placeholder="ÎŒÎ½Î¿Î¼Î±" required class="w-full px-3 py-2 border rounded"/>
        <input id="userUsername" placeholder="Username" required class="w-full px-3 py-2 border rounded"/>
        <input id="userPass" type="password" placeholder="Password" required class="w-full px-3 py-2 border rounded"/>
        <button type="submit" class="w-full bg-primary text-white py-2 rounded">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
      </form>
      <button class="mt-2 text-gray-500" onclick="closeModal('userModal')">âœ• ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
  </div>

  <!-- Product Modal -->
  <div id="productModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
    <div class="bg-white rounded-xl p-6 shadow-lg w-full max-w-md">
      <h3 class="text-xl font-semibold mb-4">ÎÎ­Î¿ Î ÏÎ¿ÏŠÏŒÎ½</h3>
      <form id="productForm" class="space-y-3">
        <input id="productNameInput" placeholder="ÎŒÎ½Î¿Î¼Î±" required class="w-full px-3 py-2 border rounded"/>
        <input id="productPriceInput" type="number" placeholder="Î¤Î¹Î¼Î®" required class="w-full px-3 py-2 border rounded"/>
        <button type="submit" class="w-full bg-primary text-white py-2 rounded">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
      </form>
      <button class="mt-2 text-gray-500" onclick="closeModal('productModal')">âœ• ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
  </div>

  <!-- Point Modal -->
  <div id="pointModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
    <div class="bg-white rounded-xl p-6 shadow-lg w-full max-w-md">
      <h3 class="text-xl font-semibold mb-4">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î£Î·Î¼ÎµÎ¯Î¿Ï…</h3>
      <form id="pointForm" class="space-y-3">
        <input id="pointNameInput" placeholder="ÎŒÎ½Î¿Î¼Î±" required class="w-full px-3 py-2 border rounded"/>
        <select id="pointAreaInput" class="w-full px-3 py-2 border rounded">
          <option>Î ÏŒÎ»Î·</option><option>Î™Î±Î»Ï…ÏƒÏŒÏ‚</option><option>Î¦Î±Î»Î·ÏÎ¬ÎºÎ¹</option><option>ÎšÎ¿Î»ÏÎ¼Ï€Î¹Î±</option>
          <option>ÎÏŒÏ„Î¹Î± Î¡ÏŒÎ´Î¿Ï‚</option><option>Î”Ï…Ï„Î¹ÎºÎ® Î¡ÏŒÎ´Î¿Ï‚</option>
        </select>
        <button type="submit" class="w-full bg-primary text-white py-2 rounded">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
      </form>
      <button class="mt-2 text-gray-500" onclick="closeModal('pointModal')">âœ• ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
  </div>

  <!-- Order Modal -->
  <div id="orderModal" class="fixed inset-0 bg-black/50 hidden items-start justify-center overflow-auto py-10">
    <div class="bg-white rounded-xl p-6 shadow-lg w-full max-w-lg">
      <h3 class="text-xl font-semibold mb-4 text-center">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚</h3>
      <form id="orderForm" class="space-y-4">
        <div>
          <label>Î£Î·Î¼ÎµÎ¯Î¿ (Î ÎµÎ»Î¬Ï„Î·Ï‚)</label>
          <input id="orderClientName" type="text" readonly class="w-full px-3 py-2 border rounded bg-gray-100"/>
        </div>
        <div>
          <label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± & ÎÏÎ±</label>
          <input id="orderDateTime" type="datetime-local" class="w-full px-3 py-2 border rounded"/>
        </div>
        <div>
          <label>Î Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚</label>
          <textarea id="orderRemarks" rows="2" class="w-full px-3 py-2 border rounded"></textarea>
        </div>
        <div>
          <label>Î•Î¯Î´Î· Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚</label>
          <div id="orderItemsContainer" class="space-y-2 max-h-40 overflow-auto"></div>
          <button type="button" onclick="addOrderItemRow()" class="mt-2 bg-primary text-white px-4 py-2 rounded">
            Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î•Î¯Î´Î¿Ï…Ï‚
          </button>
        </div>
        <div class="flex justify-between items-center pt-4">
          <span class="font-semibold">Î£ÏÎ½Î¿Î»Î¿:</span>
          <span id="orderTotal" class="text-xl font-bold">â‚¬0.00</span>
        </div>
        <button type="button" onclick="saveOrder()" class="w-full bg-success text-white py-2 rounded">
          Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·
        </button>
      </form>
      <button class="mt-2 text-gray-500" onclick="closeModal('orderModal')">âœ• ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
  </div>

  <script>
    // Initialize Firebase
    firebase.initializeApp({
      apiKey:    "AIzaSyDe966NdE-AW_eZrDCEKjw8y2h5mSdHr6o",
      authDomain:"pointregistrationapp.firebaseapp.com",
      projectId: "pointregistrationapp",
      storageBucket:"pointregistrationapp.appspot.com",
      messagingSenderId:"925139386507",
      appId:     "1:925139386507:web:588ae991f39a7bab04548e"
    });
    const db = firebase.firestore();
    let currentEditOrder = { pointId:null, orderId:null };

    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    }

    async function addOrderItemRow(item={productId:'',quantity:1}) {
      const cont = document.getElementById('orderItemsContainer');
      const row = document.createElement('div');
      row.className = 'flex gap-2 items-center';
      const sel = document.createElement('select');
      sel.className = 'flex-1 px-2 py-1 border rounded';
      const prodSnap = await db.collection('products').orderBy('name').get();
      prodSnap.forEach(d=> {
        const o = document.createElement('option');
        o.value = d.id; o.textContent = d.data().name;
        if(d.id===item.productId) o.selected=true;
        sel.append(o);
      });
      const qty = document.createElement('input');
      qty.type='number'; qty.min='1'; qty.value=item.quantity;
      qty.className='w-16 px-2 py-1 border rounded text-center';
      qty.oninput = updateOrderTotal;
      const rem = document.createElement('button');
      rem.type='button'; rem.textContent='âœ•';
      rem.className='px-2 py-1 bg-danger text-white rounded';
      rem.onclick=()=>{row.remove();updateOrderTotal();};
      row.append(sel,qty,rem);
      cont.append(row);
      updateOrderTotal();
    }

    function updateOrderTotal(){
      let tot=0;
      document.querySelectorAll('#orderItemsContainer > div').forEach(r=>{
        const q=parseInt(r.querySelector('input').value)||0;
        const pid=r.querySelector('select').value;
        tot+=(window.productsMap?.[pid]||0)*q;
      });
      document.getElementById('orderTotal').textContent=`â‚¬${tot.toFixed(2)}`;
    }

    function openEditOrder(pointId,orderId){
      currentEditOrder={pointId,orderId};
      document.getElementById('orderModal').classList.remove('hidden');
      document.getElementById('orderClientName').value='';
      db.collection('points').doc(pointId).get().then(pd=>{
        if(pd.exists)document.getElementById('orderClientName').value=pd.data().name;
      });
      document.getElementById('orderForm').reset();
      document.getElementById('orderItemsContainer').innerHTML='';
      const oRef=db.collection('points').doc(pointId).collection('orders').doc(orderId);
      oRef.get().then(d=>{
        const data=d.data()||{};
        if(data.timestamp){
          const dt=data.timestamp.toDate();
          const pad=n=>String(n).padStart(2,'0');
          document.getElementById('orderDateTime').value=
            `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
        }
        document.getElementById('orderRemarks').value=data.remarks||'';
        oRef.collection('items').get().then(s=>s.forEach(doc=>{
          const it=doc.data();
          addOrderItemRow({productId:it.productId.id.split('/').pop(),quantity:it.quantity});
        }));
      });
    }

    async function saveOrder(){
      const {pointId,orderId}=currentEditOrder;
      const oRef=db.collection('points').doc(pointId).collection('orders').doc(orderId);
      let tot=0;
      document.querySelectorAll('#orderItemsContainer > div').forEach(r=>{
        const q=parseInt(r.querySelector('input').value)||0;
        const pid=r.querySelector('select').value;
        tot+=(window.productsMap?.[pid]||0)*q;
      });
      const dt=document.getElementById('orderDateTime').value;
      const timestamp=dt
        ? firebase.firestore.Timestamp.fromDate(new Date(dt))
        : firebase.firestore.FieldValue.serverTimestamp();
      const remarks=document.getElementById('orderRemarks').value.trim();
      await oRef.update({timestamp,remarks,total:tot});
      const snap=await oRef.collection('items').get();
      const batch=db.batch();
      snap.forEach(d=>batch.delete(d.ref));
      document.querySelectorAll('#orderItemsContainer > div').forEach(r=>{
        const pid=r.querySelector('select').value;
        const q=parseInt(r.querySelector('input').value)||0;
        if(q>0){
          const ir=oRef.collection('items').doc();
          batch.set(ir,{
            productId: db.doc(`products/${pid}`),
            quantity:q,
            price:window.productsMap?.[pid]||0,
            subtotal:q*(window.productsMap?.[pid]||0)
          });
        }
      });
      await batch.commit();
      closeModal('orderModal');
    }

    function deleteOrder(pointId,orderId,btn){
      if(!confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚;'))return;
      db.collection('points').doc(pointId)
        .collection('orders').doc(orderId).delete()
        .then(()=>btn.closest('tr').remove());
    }

    function markExecuted(id,btn){
      if(!confirm('Î£Î®Î¼Î±Î½ÏƒÎ· Ï‰Ï‚ ÎµÎºÏ„ÎµÎ»ÎµÏƒÎ¼Î­Î½Î·;'))return;
      const tr=btn.closest('tr');
      tr.classList.add('bg-success','bg-opacity-20');
      btn.remove();
    }

    document.addEventListener('DOMContentLoaded',()=>{
      window.productsMap={};
      db.collection('products').get().then(s=>{
        s.docs.forEach(d=>window.productsMap[d.id]=d.data().price);
      });

      const loginForm=document.getElementById('loginForm'),
            loginModal=document.getElementById('loginModal'),
            appContent=document.getElementById('appContent'),
            logoutBtn=document.getElementById('logoutBtn');

      loginForm.addEventListener('submit',async e=>{
        e.preventDefault();
        const u=document.getElementById('loginUsername').value.trim(),
              p=document.getElementById('loginPassword').value;
        const doc=await db.collection('admins').doc(u).get();
        if(doc.exists&&doc.data().password===p){
          loginModal.classList.add('hidden');
          appContent.classList.remove('hidden');
          initAdmin();
        } else alert('Î›Î¬Î¸Î¿Ï‚ Username Î® Password');
      });

      logoutBtn.addEventListener('click',()=>location.reload());

      document.querySelectorAll('[data-tab]').forEach(li=>{
        li.addEventListener('click',()=>{
          document.querySelectorAll('.tab-content').forEach(s=>s.classList.add('hidden'));
          document.getElementById(li.dataset.tab).classList.remove('hidden');
        });
      });
    });

    function initAdmin(){
      // Users
      const uc=document.getElementById('usersContainer');
      db.collection('users').orderBy('name').onSnapshot(s=> {
        uc.innerHTML=''; s.docs.forEach(d=>{
          const div=document.createElement('div');
          const u=d.data();
          div.className='bg-white p-4 rounded shadow relative';
          div.innerHTML=`<h4 class="font-semibold">${u.name}</h4><p class="text-sm">${u.username}</p>
            <button onclick="if(confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î®;'))db.collection('users').doc('${d.id}').delete()"
              class="absolute top-2 right-2 text-red-600">ğŸ—‘ï¸</button>`;
          uc.append(div);
        });
      });
      document.getElementById('addUserBtn').onclick=()=>document.getElementById('userModal').classList.remove('hidden');

      // Products
      const pc=document.getElementById('productsContainer');
      db.collection('products').orderBy('name').onSnapshot(s=> {
        pc.innerHTML=''; s.docs.forEach(d=>{
          const p=d.data();
          const div=document.createElement('div');
          div.className='bg-white p-4 rounded shadow relative';
          div.innerHTML=`<h4 class="font-semibold">${p.name}</h4><p>â‚¬${p.price.toFixed(2)}</p>
            <button onclick="if(confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î®;'))db.collection('products').doc('${d.id}').delete()"
              class="absolute top-2 right-2 text-red-600">ğŸ—‘ï¸</button>`;
          pc.append(div);
        });
      });
      document.getElementById('addProductBtn').onclick=()=>document.getElementById('productModal').classList.remove('hidden');

      // Points
      const ptc=document.getElementById('pointsContainer');
      db.collection('points').orderBy('timestamp','desc').onSnapshot(s=> {
        ptc.innerHTML=''; s.docs.forEach(d=>{
          const p=d.data();
          const div=document.createElement('div');
          div.className='bg-white p-4 rounded shadow relative';
          div.innerHTML=`<h4 class="font-semibold">${p.name}</h4><p class="text-sm">${p.area}</p>
            <button onclick="openEditPoint('${d.id}')" class="absolute top-2 right-8 text-yellow-600">âœï¸</button>
            <button onclick="if(confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î®;'))db.collection('points').doc('${d.id}').delete()"
              class="absolute top-2 right-2 text-red-600">ğŸ—‘ï¸</button>`;
          ptc.append(div);
        });
      });

      // Orders
      const otc=document.getElementById('ordersTable');
      db.collectionGroup('orders').orderBy('timestamp','desc').onSnapshot(async s=>{
        otc.innerHTML='';
        for(const d of s.docs){
          const data=d.data();
          const parent=d.ref.parent.parent;
          const pd=await parent.get();
          const name=pd.exists?pd.data().name:parent.id;
          const tr=document.createElement('tr');
          tr.innerHTML=`<td class="border px-2 py-1">${name}</td>
            <td class="border px-2 py-1">${(data.total||0).toFixed(2)}</td>
            <td class="border px-2 py-1">${new Date(data.timestamp.toDate()).toLocaleString()}</td>
            <td class="border px-2 py-1">
              <button onclick="deleteOrder('${parent.id}','${d.id}',this)" class="text-red-600">ğŸ—‘ï¸</button>
            </td>
            <td class="border px-2 py-1">
              <button onclick="openEditOrder('${parent.id}','${d.id}')" class="text-yellow-600">âœï¸</button>
            </td>
            <td class="border px-2 py-1">
              <button onclick="markExecuted('${d.id}',this)" class="text-green-600">âœ”ï¸</button>
            </td>`;
          otc.append(tr);
        }
      });
      document.getElementById('refreshOrdersBtn').onclick=()=>initAdmin();
    }

    function openEditPoint(id){
      db.collection('points').doc(id).get().then(d=>{
        const data=d.data()||{};
        document.getElementById('pointNameInput').value=data.name||'';
        document.getElementById('pointAreaInput').value=data.area||'';
        document.getElementById('pointModal').classList.remove('hidden');
        document.getElementById('pointForm').onsubmit=async e=>{
          e.preventDefault();
          await db.collection('points').doc(id).update({
            name:document.getElementById('pointNameInput').value.trim(),
            area:document.getElementById('pointAreaInput').value
          });
          closeModal('pointModal');
        };
      });
    }
  </script>
</body>
</html>
