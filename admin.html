<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Πίνακας Διαχείρισης</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
        extend: {
          colors: {
            primary: '#4f46e5', accent: '#f59e0b',
            danger: '#dc2626', success: '#16a34a',
            softbg: '#f8fafc'
          }
        }
      }
    };
  </script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-softbg font-sans text-gray-800 min-h-screen flex flex-col items-center">

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black/50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 shadow-lg w-full max-w-sm">
      <h2 class="text-2xl font-bold text-primary mb-4 text-center">Σύνδεση Διαχειριστή</h2>
      <form id="loginForm" class="space-y-4">
        <input id="loginUsername" type="text" placeholder="Username" required
               class="w-full px-4 py-2 border rounded"/>
        <input id="loginPassword" type="password" placeholder="Password" required
               class="w-full px-4 py-2 border rounded"/>
        <button type="submit" class="w-full bg-primary text-white py-2 rounded">Σύνδεση</button>
      </form>
    </div>
  </div>

  <!-- Main App -->
  <div id="appContent" class="hidden w-full max-w-5xl flex flex-col flex-1">

    <!-- Navbar -->
    <nav class="w-full bg-white shadow px-6 py-4 flex justify-between items-center">
      <h1 class="text-3xl font-bold text-primary">Πίνακας Διαχείρισης</h1>
      <button id="logoutBtn" class="bg-danger text-white px-4 py-2 rounded">Αποσύνδεση</button>
    </nav>

    <!-- Tabs -->
    <div class="bg-white w-full px-6">
      <ul id="tabs" class="flex space-x-6 border-b">
        <li data-tab="users" class="py-2 cursor-pointer hover:text-primary">Χρήστες</li>
        <li data-tab="products" class="py-2 cursor-pointer hover:text-primary">Προϊόντα</li>
        <li data-tab="points" class="py-2 cursor-pointer hover:text-primary">Σημεία</li>
        <li data-tab="orders" class="py-2 cursor-pointer hover:text-primary">Παραγγελίες</li>
      </ul>
    </div>

    <!-- Content -->
    <main class="flex-1 overflow-auto p-6">

      <!-- Users Tab -->
      <section id="users" class="tab-content hidden">
        <button id="addUserBtn" class="mb-4 bg-success text-white px-4 py-2 rounded">Προσθήκη Χρήστη</button>
        <div id="usersContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>

      <!-- Products Tab -->
      <section id="products" class="tab-content hidden">
        <button id="addProductBtn" class="mb-4 bg-success text-white px-4 py-2 rounded">Προσθήκη Προϊόντος</button>
        <div id="productsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>

      <!-- Points Tab -->
      <section id="points" class="tab-content hidden">
        <div id="pointsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>

      <!-- Orders Tab -->
      <section id="orders" class="tab-content hidden">
        <button id="refreshOrdersBtn" class="mb-4 bg-accent text-white px-4 py-2 rounded">Ανανέωση</button>
        <table class="w-full bg-white rounded-xl shadow overflow-hidden text-center">
          <thead class="bg-primary text-white">
            <tr>
              <th class="px-4 py-2">Σημείο</th>
              <th class="px-4 py-2">Σύνολο (€)</th>
              <th class="px-4 py-2">Ώρα</th>
              <th class="px-4 py-2">Διαγρ.</th>
              <th class="px-4 py-2">Επεξ.</th>
              <th class="px-4 py-2">Ολοκλ.</th>
            </tr>
          </thead>
          <tbody id="ordersTable"></tbody>
        </table>
      </section>

    </main>
  </div>

  <!-- Modals -->

  <!-- User Modal -->
  <div id="userModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
    <div class="bg-white rounded-xl p-6 shadow-lg w-full max-w-md">
      <h3 class="text-xl font-semibold mb-4">Νέος Χρήστης</h3>
      <form id="userForm" class="space-y-3">
        <input id="userName" placeholder="Όνομα" required class="w-full px-3 py-2 border rounded"/>
        <input id="userUsername" placeholder="Username" required class="w-full px-3 py-2 border rounded"/>
        <input id="userPass" type="password" placeholder="Password" required class="w-full px-3 py-2 border rounded"/>
        <button type="submit" class="w-full bg-primary text-white py-2 rounded">Αποθήκευση</button>
      </form>
      <button class="mt-2 text-gray-500" onclick="closeModal('userModal')">✕ Κλείσιμο</button>
    </div>
  </div>

  <!-- Product Modal -->
  <div id="productModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
    <div class="bg-white rounded-xl p-6 shadow-lg w-full max-w-md">
      <h3 class="text-xl font-semibold mb-4">Νέο Προϊόν</h3>
      <form id="productForm" class="space-y-3">
        <input id="productNameInput" placeholder="Όνομα" required class="w-full px-3 py-2 border rounded"/>
        <input id="productPriceInput" type="number" placeholder="Τιμή" required class="w-full px-3 py-2 border rounded"/>
        <button type="submit" class="w-full bg-primary text-white py-2 rounded">Αποθήκευση</button>
      </form>
      <button class="mt-2 text-gray-500" onclick="closeModal('productModal')">✕ Κλείσιμο</button>
    </div>
  </div>

  <!-- Point Modal -->
  <div id="pointModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
    <div class="bg-white rounded-xl p-6 shadow-lg w-full max-w-md">
      <h3 class="text-xl font-semibold mb-4">Επεξεργασία Σημείου</h3>
      <form id="pointForm" class="space-y-3">
        <input id="pointNameInput" placeholder="Όνομα" required class="w-full px-3 py-2 border rounded"/>
        <select id="pointAreaInput" class="w-full px-3 py-2 border rounded">
          <option>Πόλη</option><option>Ιαλυσός</option><option>Φαληράκι</option><option>Κολύμπια</option>
          <option>Νότια Ρόδος</option><option>Δυτική Ρόδος</option>
        </select>
        <button type="submit" class="w-full bg-primary text-white py-2 rounded">Αποθήκευση</button>
      </form>
      <button class="mt-2 text-gray-500" onclick="closeModal('pointModal')">✕ Κλείσιμο</button>
    </div>
  </div>

  <!-- Order Modal -->
  <div id="orderModal" class="fixed inset-0 bg-black/50 hidden items-start justify-center overflow-auto py-10">
    <div class="bg-white rounded-xl p-6 shadow-lg w-full max-w-lg">
      <h3 class="text-xl font-semibold mb-4 text-center">Επεξεργασία Παραγγελίας</h3>
      <form id="orderForm" class="space-y-4">
        <div>
          <label>Σημείο (Πελάτης)</label>
          <input id="orderClientName" type="text" readonly class="w-full px-3 py-2 border rounded bg-gray-100"/>
        </div>
        <div>
          <label>Ημερομηνία & Ώρα</label>
          <input id="orderDateTime" type="datetime-local" class="w-full px-3 py-2 border rounded"/>
        </div>
        <div>
          <label>Παρατηρήσεις</label>
          <textarea id="orderRemarks" rows="2" class="w-full px-3 py-2 border rounded"></textarea>
        </div>
        <div>
          <label>Είδη Παραγγελίας</label>
          <div id="orderItemsContainer" class="space-y-2 max-h-40 overflow-auto"></div>
          <button type="button" onclick="addOrderItemRow()" class="mt-2 bg-primary text-white px-4 py-2 rounded">
            Προσθήκη Είδους
          </button>
        </div>
        <div class="flex justify-between items-center pt-4">
          <span class="font-semibold">Σύνολο:</span>
          <span id="orderTotal" class="text-xl font-bold">€0.00</span>
        </div>
        <button type="button" onclick="saveOrder()" class="w-full bg-success text-white py-2 rounded">
          Αποθήκευση
        </button>
      </form>
      <button class="mt-2 text-gray-500" onclick="closeModal('orderModal')">✕ Κλείσιμο</button>
    </div>
  </div>

  <script>
    // Initialize Firebase
    firebase.initializeApp({
      apiKey:    "AIzaSyDe966NdE-AW_eZrDCEKjw8y2h5mSdHr6o",
      authDomain:"pointregistrationapp.firebaseapp.com",
      projectId: "pointregistrationapp",
      storageBucket:"pointregistrationapp.appspot.com",
      messagingSenderId:"925139386507",
      appId:     "1:925139386507:web:588ae991f39a7bab04548e"
    });
    const db = firebase.firestore();
    let currentEditOrder = { pointId:null, orderId:null };

    // Utility to close modals
    function closeModal(id){ document.getElementById(id).classList.add('hidden'); }

    // Add an order-item row
    async function addOrderItemRow(item={productId:'',quantity:1}) {
      const cont = document.getElementById('orderItemsContainer');
      const row = document.createElement('div');
      row.className = 'flex gap-2 items-center';
      // Product select
      const sel = document.createElement('select');
      sel.className = 'flex-1 px-2 py-1 border rounded';
      const prodSnap = await db.collection('products').orderBy('name').get();
      prodSnap.forEach(d=> {
        const o = document.createElement('option');
        o.value = d.id; o.textContent = d.data().name;
        if(d.id===item.productId) o.selected=true;
        sel.append(o);
      });
      // qty
      const qty = document.createElement('input');
      qty.type='number'; qty.min='1'; qty.value=item.quantity;
      qty.className='w-16 px-2 py-1 border rounded text-center';
      qty.oninput = updateOrderTotal;
      // remove btn
      const rem = document.createElement('button');
      rem.type='button'; rem.textContent='✕';
      rem.className='px-2 py-1 bg-danger text-white rounded';
      rem.onclick=()=>{row.remove();updateOrderTotal();};
      row.append(sel,qty,rem);
      cont.append(row);
      updateOrderTotal();
    }

    function updateOrderTotal(){
      let tot=0;
      document.querySelectorAll('#orderItemsContainer > div').forEach(r=> {
        const q = parseInt(r.querySelector('input').value)||0;
        const pid = r.querySelector('select').value;
        const price = window.productsMap?.[pid]||0;
        tot += price*q;
      });
      document.getElementById('orderTotal').textContent=`€${tot.toFixed(2)}`;
    }

    function openEditOrder(pointId,orderId){
      currentEditOrder={pointId,orderId};
      document.getElementById('orderModal').classList.remove('hidden');
      document.getElementById('orderClientName').value='';
      db.collection('points').doc(pointId).get().then(pd=>{
        if(pd.exists)document.getElementById('orderClientName').value=pd.data().name;
      });
      document.getElementById('orderForm').reset();
      document.getElementById('orderItemsContainer').innerHTML='';
      // load order
      const oRef=db.collection('points').doc(pointId).collection('orders').doc(orderId);
      oRef.get().then(d=>{
        const data=d.data()||{};
        if(data.timestamp){
          const dt=data.timestamp.toDate();
          const pad=n=>String(n).padStart(2,'0');
          document.getElementById('orderDateTime').value=
            `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
        }
        document.getElementById('orderRemarks').value=data.remarks||'';
        oRef.collection('items').get().then(s=>s.forEach(doc=>{
          const it=doc.data();
          addOrderItemRow({productId:it.productId.id.split('/').pop(),quantity:it.quantity});
        }));
      });
    }

    async function saveOrder(){
      const {pointId,orderId}=currentEditOrder;
      const oRef=db.collection('points').doc(pointId).collection('orders').doc(orderId);
      // compute total
      let tot=0;
      document.querySelectorAll('#orderItemsContainer > div').forEach(r=>{
        const q=parseInt(r.querySelector('input').value)||0;
        const pid=r.querySelector('select').value;
        tot+= (window.productsMap?.[pid]||0)*q;
      });
      // update
      const dt=document.getElementById('orderDateTime').value;
      const timestamp = dt
        ? firebase.firestore.Timestamp.fromDate(new Date(dt))
        : firebase.firestore.FieldValue.serverTimestamp();
      const remarks=document.getElementById('orderRemarks').value.trim();
      await oRef.update({timestamp,remarks,total:tot});
      // replace items
      const snap=await oRef.collection('items').get();
      const batch=db.batch();
      snap.forEach(d=>batch.delete(d.ref));
      document.querySelectorAll('#orderItemsContainer > div').forEach(r=>{
        const pid=r.querySelector('select').value;
        const q=parseInt(r.querySelector('input').value)||0;
        if(q>0){
          const ir=oRef.collection('items').doc();
          batch.set(ir,{
            productId: db.doc(`products/${pid}`),
            quantity:q,
            price:window.productsMap?.[pid]||0,
            subtotal:q*(window.productsMap?.[pid]||0)
          });
        }
      });
      await batch.commit();
      closeModal('orderModal');
      // onSnapshot θα ανανεώσει αυτόματα
    }

    function deleteOrder(pointId,orderId,btn){
      if(!confirm('Διαγραφή παραγγελίας;'))return;
      db.collection('points').doc(pointId)
        .collection('orders').doc(orderId).delete()
        .then(()=> btn.closest('tr').remove() );
    }

    function markExecuted(id,btn){
      if(!confirm('Σήμανση ως εκτελεσμένη;'))return;
      const tr=btn.closest('tr');
      tr.classList.add('bg-success','bg-opacity-20');
      btn.remove();
    }

    // --- Document Ready ---
    document.addEventListener('DOMContentLoaded',()=>{
      // Firebase productsMap
      window.productsMap={};
      db.collection('products').get().then(s=>{
        s.docs.forEach(d=>window.productsMap[d.id]=d.data().price);
      });

      const loginForm=document.getElementById('loginForm'),
            loginModal=document.getElementById('loginModal'),
            appContent=document.getElementById('appContent'),
            logoutBtn=document.getElementById('logoutBtn');

      loginForm.addEventListener('submit',async e=>{
        e.preventDefault();
        const u=document.getElementById('loginUsername').value.trim(),
              p=document.getElementById('loginPassword').value;
        const doc=await db.collection('admins').doc(u).get();
        if(doc.exists&&doc.data().password===p){
          loginModal.classList.add('hidden');
          appContent.classList.remove('hidden');
          initAdmin();
        } else alert('Λάθος Username ή Password');
      });

      logoutBtn.addEventListener('click',()=>location.reload());

      // tabs
      document.querySelectorAll('[data-tab]').forEach(li=>{
        li.addEventListener('click',()=>{
          document.querySelectorAll('.tab-content').forEach(s=>s.classList.add('hidden'));
          document.getElementById(li.dataset.tab).classList.remove('hidden');
        });
      });
    });

    // initAdmin: attach onSnapshot listeners
    function initAdmin(){
      // USERS
      const uc=document.getElementById('usersContainer');
      uc.innerHTML='';
      db.collection('users').orderBy('name').onSnapshot(s=>{
        uc.innerHTML='';
        s.docs.forEach(d=> uc.appendChild(cardUser(d)));
      });
      document.getElementById('addUserBtn').onclick=()=>document.getElementById('userModal').classList.remove('hidden');
      document.getElementById('userForm').onsubmit=async e=>{
        e.preventDefault();
        await db.collection('users').add({
          name:document.getElementById('userName').value.trim(),
          username:document.getElementById('userUsername').value.trim(),
          role:'Χρήστης',
          password:document.getElementById('userPass').value
        });
        closeModal('userModal');
      };

      // PRODUCTS
      const pc=document.getElementById('productsContainer');
      pc.innerHTML='';
      db.collection('products').orderBy('name').onSnapshot(s=>{
        pc.innerHTML='';
        s.docs.forEach(d=> pc.appendChild(cardProduct(d)));
      });
      document.getElementById('addProductBtn').onclick=()=>document.getElementById('productModal').classList.remove('hidden');
      document.getElementById('productForm').onsubmit=async e=>{
        e.preventDefault();
        await db.collection('products').add({
          name:document.getElementById('productNameInput').value.trim(),
          price:parseFloat(document.getElementById('productPriceInput').value)
        });
        closeModal('productModal');
      };

      // POINTS
      const ptc=document.getElementById('pointsContainer');
      ptc.innerHTML='';
      db.collection('points').orderBy('timestamp','desc').onSnapshot(s=>{
        ptc.innerHTML='';
        s.docs.forEach(d=> ptc.appendChild(cardPoint(d)));
      });

      // ORDERS
      const otc=document.getElementById('ordersTable');
      db.collectionGroup('orders').orderBy('timestamp','desc').onSnapshot(async s=>{
        otc.innerHTML='';
        for(const d of s.docs){
          const pd = await d.ref.parent.parent.get();
          const pname = pd.exists?pd.data().name:pd.id;
          otc.appendChild(rowOrder(d,pname));
        }
      });
      document.getElementById('refreshOrdersBtn').onclick=()=>initAdmin();
    }

    // Card generators
    function cardUser(d){
      const div=document.createElement('div');
      const u=d.data();
      div.className='bg-white p-4 rounded-lg shadow relative';
      div.innerHTML=`
        <h4 class="font-semibold">${u.name}</h4>
        <p class="text-sm text-gray-600">${u.username}</p>
        <div class="absolute top-2 right-2 space-x-1">
          <button onclick="if(confirm('Διαγραφή χρήστη;'))db.collection('users').doc('${d.id}').delete()" class="text-red-600">🗑️</button>
        </div>`;
      return div;
    }
    function cardProduct(d){
      const div=document.createElement('div');
      const p=d.data();
      div.className='bg-white p-4 rounded-lg shadow relative';
      div.innerHTML=`
        <h4 class="font-semibold">${p.name}</h4>
        <p class="text-gray-700">€${p.price.toFixed(2)}</p>
        <div class="absolute top-2 right-2 space-x-1">
          <button onclick="if(confirm('Διαγραφή προϊόντος;'))db.collection('products').doc('${d.id}').delete()" class="text-red-600">🗑️</button>
        </div>`;
      return div;
    }
    function cardPoint(d){
      const div=document.createElement('div');
      const p=d.data();
      div.className='bg-white p-4 rounded-lg shadow relative';
      div.innerHTML=`
        <h4 class="font-semibold">${p.name}</h4>
        <p class="text-sm text-gray-600">${p.area}</p>
        <div class="absolute top-2 right-2 space-x-1">
          <button onclick="openEditPoint('${d.id}')" class="text-yellow-600">✏️</button>
          <button onclick="if(confirm('Διαγραφή σημείου;'))db.collection('points').doc('${d.id}').delete()" class="text-red-600">🗑️</button>
        </div>`;
      return div;
    }
    function rowOrder(d, pname){
      const data=d.data();
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td class="border px-2 py-1">${pname}</td>
        <td class="border px-2 py-1">${data.total?.toFixed(2)||'0.00'}</td>
        <td class="border px-2 py-1">${new Date(data.timestamp.toDate()).toLocaleString()}</td>
        <td class="border px-2 py-1">
          <button onclick="deleteOrder('${d.ref.parent.parent.id}','${d.id}',this)" class="text-red-600">🗑️</button>
        </td>
        <td class="border px-2 py-1">
          <button onclick="openEditOrder('${d.ref.parent.parent.id}','${d.id}')" class="text-yellow-600">✏️</button>
        </td>
        <td class="border px-2 py-1">
          <button onclick="markExecuted('${d.id}',this)" class="text-green-600">✔️</button>
        </td>`;
      return tr;
    }

    function openEditPoint(id){
      db.collection('points').doc(id).get().then(d=>{
        const data=d.data()||{};
        document.getElementById('pointNameInput').value=data.name||'';
        document.getElementById('pointAreaInput').value=data.area||'';
        document.getElementById('pointModal').classList.remove('hidden');
        document.getElementById('pointForm').onsubmit=async e=>{
          e.preventDefault();
          await db.collection('points').doc(id).update({
            name:document.getElementById('pointNameInput').value.trim(),
            area:document.getElementById('pointAreaInput').value
          });
          closeModal('pointModal');
        };
      });
    }
  </script>
</body>
</html>
