<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Πίνακας Διαχείρισης</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-softbg text-darktext min-h-screen flex flex-col">

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm">
      <h2 class="text-2xl font-bold mb-4">Σύνδεση Διαχειριστή</h2>
      <form id="loginForm" class="space-y-4">
        <label class="block">Όνομα Χρήστη
          <input type="text" id="loginUsername" required class="w-full border px-3 py-2 rounded"/>
        </label>
        <label class="block">Κωδικός
          <input type="password" id="loginPassword" required class="w-full border px-3 py-2 rounded"/>
        </label>
        <div class="text-right">
          <button type="submit" class="bg-primary text-white px-4 py-2 rounded">Σύνδεση</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Admin App Content -->
  <div id="appContent" class="hidden flex flex-col flex-1">

    <!-- Navbar -->
    <nav class="bg-white shadow px-4 py-3 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-primary uppercase">Πίνακας Διαχείρισης</h1>
      <button id="logoutBtn" class="bg-danger text-white px-3 py-1 rounded">Αποσύνδεση</button>
    </nav>

    <!-- Tabs -->
    <div class="flex border-b bg-white px-4">
      <button data-tab="users" class="py-2 px-4 text-sm uppercase font-medium">Χρήστες</button>
      <button data-tab="products" class="py-2 px-4 text-sm uppercase font-medium">Προϊόντα</button>
      <button data-tab="points" class="py-2 px-4 text-sm uppercase font-medium">Σημεία</button>
    </div>

    <!-- Content -->
    <main class="flex-1 overflow-auto p-4">
      <!-- Users Tab -->
      <section id="users" class="tab-content hidden">
        <div id="usersContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>
      <!-- Products Tab -->
      <section id="products" class="tab-content hidden">
        <button id="addProductBtn" class="bg-green-600 text-white px-3 py-1 rounded mb-4">Προσθήκη Προϊόντος</button>
        <div id="productsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>
      <!-- Points Tab -->
      <section id="points" class="tab-content hidden">
        <div id="pointsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>
    </main>
  </div>

  <!-- Add Product Modal -->
  <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm">
      <h2 class="text-xl font-bold mb-4">Προσθήκη Προϊόντος</h2>
      <form id="productForm" class="space-y-4">
        <label class="block">Όνομα
          <input type="text" id="productName" required class="w-full border px-3 py-2 rounded"/>
        </label>
        <label class="block">Τιμή (€)
          <input type="number" id="productPrice" required class="w-full border px-3 py-2 rounded"/>
        </label>
        <div class="text-right">
          <button type="submit" class="bg-primary text-white px-4 py-2 rounded">Αποθήκευση</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Firebase init
    firebase.initializeApp({
      apiKey: "AIzaSyDe966NdE-AW_eZrDCEKjw8y2h5mSdHr6o",
      authDomain: "pointregistrationapp.firebaseapp.com",
      projectId: "pointregistrationapp",
      storageBucket: "pointregistrationapp.appspot.com",
      messagingSenderId: "925139386507",
      appId: "1:925139386507:web:588ae991f39a7bab04548e"
    });
    const db = firebase.firestore();

    document.addEventListener("DOMContentLoaded", () => {
      const loginForm  = document.getElementById("loginForm");
      const loginModal = document.getElementById("loginModal");
      const appContent = document.getElementById("appContent");
      const logoutBtn  = document.getElementById("logoutBtn");

      loginForm.addEventListener("submit", async e => {
        e.preventDefault();
        const user = document.getElementById("loginUsername").value.trim();
        const pass = document.getElementById("loginPassword").value;
        const doc = await db.collection("admins").doc(user).get();
        if(doc.exists && doc.data().password === pass) {
          loginModal.classList.add("hidden");
          appContent.classList.remove("hidden");
          initAdmin();
        } else {
          alert("Λάθος διαπιστευτήρια");
        }
      });
      logoutBtn.addEventListener("click", () => location.reload());

      document.querySelectorAll("[data-tab]").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".tab-content").forEach(s => s.classList.add("hidden"));
          document.getElementById(btn.dataset.tab).classList.remove("hidden");
        });
      });
    });

    function clientCard(cust) {
      const c = document.createElement("div");
      c.className = "relative bg-white rounded-xl p-4 shadow-xl transform hover:-translate-y-1 transition overflow-hidden";
      const ab = document.createElement("div");
      ab.className = "absolute top-2 left-1/2 transform -translate-x-1/2 bg-region text-white px-2 py-0.5 rounded-full text-xs uppercase";
      ab.textContent = "ΧΡΗΣΤΗΣ"; c.appendChild(ab);
      const h3 = document.createElement("h3");
      h3.className = "mt-6 text-center text-lg font-bold uppercase text-darktext break-words";
      h3.textContent = cust.name; c.appendChild(h3);
      if(cust.username) {
        const p = document.createElement("p");
        p.className = "text-center text-sm text-gray-500 mt-2";
        p.textContent = "username: " + cust.username;
        c.appendChild(p);
      }
      if(cust.role) {
        const p = document.createElement("p");
        p.className = "text-center text-sm text-gray-500";
        p.textContent = "role: " + cust.role;
        c.appendChild(p);
      }
      return c;
    }

    function productCard(prod) {
      const c = document.createElement("div");
      c.className = "bg-white rounded-xl p-4 shadow";
      c.innerHTML = `
        <h3 class="text-lg font-bold mb-2 uppercase">${prod.name}</h3>
        <p class="text-gray-700">€${prod.price.toFixed(2)}</p>
      `;
      return c;
    }

    function pointCard(pt) {
      const c = document.createElement("div");
      c.className = "relative bg-white rounded-xl p-4 shadow";
      const ab = document.createElement("div");
      ab.className = "absolute top-2 left-1/2 transform -translate-x-1/2 bg-region text-white px-2 py-0.5 rounded-full text-xs uppercase";
      ab.textContent = pt.area; c.appendChild(ab);
      const h3 = document.createElement("h3");
      h3.className = "mt-6 text-center text-lg font-bold uppercase text-darktext";
      h3.textContent = pt.name; c.appendChild(h3);
      return c;
    }

    function initAdmin() {
      // Default to users tab
      document.querySelector("[data-tab='users']").click();

      // Load users
      db.collection("users").orderBy("name").onSnapshot(snap => {
        const cont = document.getElementById("usersContainer");
        cont.innerHTML = "";
        snap.docs.forEach(d => cont.appendChild(clientCard(d.data())));
      });

      // Load products
      document.getElementById("addProductBtn").addEventListener("click", () => {
        document.getElementById("productModal").classList.remove("hidden");
      });
      document.getElementById("productForm").addEventListener("submit", async e => {
        e.preventDefault();
        const n = document.getElementById("productName").value.trim();
        const p = parseFloat(document.getElementById("productPrice").value);
        if(n && !isNaN(p)) {
          await db.collection("products").add({ name: n, price: p });
          e.target.reset();
          document.getElementById("productModal").classList.add("hidden");
        }
      });
      db.collection("products").onSnapshot(snap => {
        const cont = document.getElementById("productsContainer");
        cont.innerHTML = "";
        snap.docs.forEach(d => cont.appendChild(productCard(d.data())));
      });

      // Load points
      db.collection("points").orderBy("timestamp","desc").onSnapshot(snap => {
        const cont = document.getElementById("pointsContainer");
        cont.innerHTML = "";
        snap.docs.forEach(d => cont.appendChild(pointCard(d.data())));
      });
    }
  </script>

</body>
</html>
