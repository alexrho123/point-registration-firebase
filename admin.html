<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Admin Panel – Διαχείριση</title>

  <!-- Tailwind CSS + custom colors -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1D4ED8',
            accent:  '#FACC15',
            danger:  '#DC2626',
            success: '#16A34A',
            region:  '#8B5CF6',
            softbg:  '#f0f8ff',
            darktext:'#1f2937'
          }
        }
      }
    }
  </script>

  <style>
    /* Center modals, add transition & backdrop blur */
    #addProductModal,
    #liveOrdersModal,
    #executedOrdersModal,
    #orderDetailModal {
      transition: opacity 0.2s ease;
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-softbg text-darktext min-h-screen flex flex-col">

  <!-- Header & Nav -->
  <header class="w-full bg-white shadow">
    <div class="max-w-3xl mx-auto px-4 py-3 flex flex-col sm:flex-row items-center justify-between">
      <h1 class="text-2xl font-extrabold text-primary uppercase">Admin Panel</h1>
      <nav class="mt-2 sm:mt-0 flex space-x-2">
        <a href="index.html" class="px-3 py-1 bg-region text-white rounded uppercase text-sm hover:bg-region/90">Αρχική</a>
        <a href="admin.html"  class="px-3 py-1 bg-accent text-white rounded uppercase text-sm hover:bg-accent/90">Admin</a>
      </nav>
    </div>
  </header>

  <!-- Login Screen -->
  <div id="loginContainer" class="flex-1 flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center mb-6">Admin Login</h2>
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block mb-1">Όνομα χρήστη</label>
          <input id="username" type="text" required class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-primary"/>
        </div>
        <div>
          <label class="block mb-1">Κωδικός</label>
          <input id="password" type="password" required class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-primary"/>
        </div>
        <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90">Σύνδεση</button>
      </form>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden flex-1 w-full max-w-3xl mx-auto p-6 flex flex-col gap-8">
    <h1 class="text-3xl font-bold text-primary mb-4 text-center">Πίνακας Διαχείρισης</h1>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
      <!-- Προσθήκη Προϊόντων -->
      <div id="addProductsCard"
           class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition p-6 cursor-pointer flex flex-col items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-accent mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 12h18M3 17h18" />
        </svg>
        <h2 class="text-xl font-semibold">Προσθήκη Προϊόντων</h2>
      </div>
      <!-- Live Παραγγελίες -->
      <div id="liveOrdersCard"
           class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition p-6 cursor-pointer flex flex-col items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-primary mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 10h18M3 6h18M3 14h18M3 18h18" />
        </svg>
        <h2 class="text-xl font-semibold">Live Παραγγελίες</h2>
      </div>
      <!-- Εκτελεσμένες Παραγγελίες -->
      <div id="executedOrdersCard"
           class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition p-6 cursor-pointer flex flex-col items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-success mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <h2 class="text-xl font-semibold">Εκτελεσμένες Παραγγελίες</h2>
      </div>
    </div>
  </div>

  <!-- Add Products Modal -->
  <div id="addProductModal"
       class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none">
    <div class="bg-white rounded-2xl w-full max-w-lg p-8 relative shadow-2xl">
      <button onclick="closeAddProductModal()"
              class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl">&times;</button>
      <h2 class="text-2xl font-bold text-primary mb-6 text-center">Προσθήκη Προϊόντων</h2>
      <form id="productForm" class="space-y-4">
        <div id="productRows" class="space-y-3">
          <div class="flex gap-3">
            <input type="text" placeholder="Όνομα προϊόντος" required
                   class="flex-1 border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-region"/>
            <input type="number" placeholder="Τιμή" step="0.01" required
                   class="w-24 border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-region"/>
            <button type="button" onclick="removeRow(this)"
                    class="text-danger hover:text-red-700 text-3xl leading-none">&minus;</button>
          </div>
        </div>
        <div class="flex justify-between items-center">
          <button type="button" onclick="addRow()"
                  class="bg-accent text-white px-5 py-2 rounded-lg hover:bg-accent/90">
            + Νέα Γραμμή
          </button>
          <div class="space-x-3">
            <button type="button" onclick="closeAddProductModal()"
                    class="px-5 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">
              Ακύρωση
            </button>
            <button type="submit" class="bg-success text-white px-5 py-2 rounded-lg hover:bg-success/90">
              Αποθήκευση
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Live Orders Modal -->
  <div id="liveOrdersModal"
       class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none">
    <div class="bg-white rounded-2xl w-full max-w-2xl p-8 relative shadow-2xl">
      <button onclick="closeLiveOrdersModal()"
              class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl">&times;</button>
      <h2 class="text-2xl font-bold text-primary mb-6 text-center">Ζωντανές Παραγγελίες</h2>
      <div id="ordersList" class="space-y-4 max-h-96 overflow-auto"></div>
    </div>
  </div>

  <!-- Executed Orders Modal -->
  <div id="executedOrdersModal"
       class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none">
    <div class="bg-white rounded-2xl w-full max-w-2xl p-8 relative shadow-2xl">
      <button onclick="closeExecutedOrdersModal()"
              class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl">&times;</button>
      <h2 class="text-2xl font-bold text-success mb-6 text-center">Εκτελεσμένες Παραγγελίες</h2>
      <div id="executedList" class="space-y-4 max-h-96 overflow-auto"></div>
    </div>
  </div>

  <!-- Order Detail Modal -->
  <div id="orderDetailModal"
       class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none">
    <div class="bg-white rounded-2xl w-full max-w-lg p-8 relative shadow-2xl">
      <button onclick="closeOrderDetailModal()"
              class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl">&times;</button>
      <h2 id="detailTitle" class="text-2xl font-bold text-primary mb-6 text-center">Λεπτομέρειες Παραγγελίας</h2>
      <div id="detailContent" class="space-y-3 max-h-72 overflow-auto px-2"></div>
      <div class="mt-6 flex justify-between">
        <button id="executeOrderBtn"
                class="bg-success text-white px-6 py-2 rounded-lg hover:bg-success/90">
          Εκτέλεση Παραγγελίας
        </button>
        <button id="cancelOrderBtn"
                class="bg-danger text-white px-6 py-2 rounded-lg hover:bg-danger/90">
          Ακύρωση παραγγελίας
        </button>
      </div>
    </div>
  </div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey:    "AIzaSyDe966NdE-AW_eZrDCEKjw8y2h5mSdHr6o",
      authDomain:"pointregistrationapp.firebaseapp.com",
      projectId: "pointregistrationapp",
      storageBucket:"pointregistrationapp.appspot.com",
      messagingSenderId:"925139386507",
      appId:     "1:925139386507:web:588ae991f39a7bab04548e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Login handling
    document.getElementById('loginForm').onsubmit = async e => {
      e.preventDefault();
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value;
      const docRef = db.collection('users').doc(user);
      const doc = await docRef.get();
      if (!doc.exists) {
        if (user === 'admin' && pass === '123') {
          await docRef.set({ password: '123' });
        } else {
          return alert('Σφάλμα σύνδεσης');
        }
      }
      const data = (await docRef.get()).data();
      if (data.password === pass) {
        document.getElementById('loginContainer').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
      } else {
        alert('Σφάλμα σύνδεσης');
      }
    };

    // Προϊόντα modal controls
    const addProductModal = document.getElementById('addProductModal');
    window.openAddProductModal = () => addProductModal.classList.remove('opacity-0','pointer-events-none');
    window.closeAddProductModal = () => {
      addProductModal.classList.add('opacity-0','pointer-events-none');
      document.getElementById('productForm').reset();
      document.getElementById('productRows').innerHTML = `
        <div class="flex gap-3">
          <input type="text" placeholder="Όνομα προϊόντος" required class="flex-1 border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-region"/>
          <input type="number" placeholder="Τιμή" step="0.01" required class="w-24 border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-region"/>
          <button type="button" onclick="removeRow(this)" class="text-danger hover:text-red-700 text-3xl leading-none">&minus;</button>
        </div>`;
    };
    document.getElementById('addProductsCard').onclick = openAddProductModal;
    function addRow() {
      const rows = document.getElementById('productRows');
      const div = document.createElement('div');
      div.className = 'flex gap-3';
      div.innerHTML = `
        <input type="text" placeholder="Όνομα προϊόντος" required class="flex-1 border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-region"/>
        <input type="number" placeholder="Τιμή" step="0.01" required class="w-24 border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-region"/>
        <button type="button" onclick="removeRow(this)" class="text-danger hover:text-red-700 text-3xl leading-none">&minus;</button>`;
      rows.appendChild(div);
    }
    function removeRow(btn) { btn.closest('div').remove(); }
    document.getElementById('productForm').onsubmit = async e => {
      e.preventDefault();
      for (let row of [...document.getElementById('productRows').children]) {
        const name = row.querySelector('input[type=text]').value.trim();
        const price = parseFloat(row.querySelector('input[type=number]').value);
        if (name && !isNaN(price)) await db.collection('products').add({ name, price });
      }
      alert('Προϊόντα αποθηκεύτηκαν');
      closeAddProductModal();
    };

    // Live Orders
    const liveOrdersModal     = document.getElementById('liveOrdersModal'),
          ordersList          = document.getElementById('ordersList'),
          executedOrdersModal = document.getElementById('executedOrdersModal'),
          executedList        = document.getElementById('executedList'),
          orderDetailModal    = document.getElementById('orderDetailModal'),
          detailTitle         = document.getElementById('detailTitle'),
          detailContent       = document.getElementById('detailContent'),
          executeOrderBtn     = document.getElementById('executeOrderBtn'),
          cancelOrderBtn      = document.getElementById('cancelOrderBtn');

    let currentOrderRef = null;

    document.getElementById('liveOrdersCard').onclick = openLiveOrdersModal;
    function openLiveOrdersModal(){
      ordersList.innerHTML = '<p class="text-center text-gray-500">Φόρτωση…</p>';
      liveOrdersModal.classList.remove('opacity-0','pointer-events-none');
      db.collectionGroup('orders')
        .orderBy('timestamp','desc')
        .onSnapshot(async snap=>{
          ordersList.innerHTML = '';
          const today = new Date().toDateString();
          for (let doc of snap.docs) {
            const od = doc.data();
            if (od.executed) continue;
            const ts = od.timestamp?.toDate();
            if (ts && ts.toDateString()!==today) continue;
            const itemsSnap = await doc.ref.collection('items').get();
            let qty = 0; itemsSnap.docs.forEach(i => qty += i.data().quantity);
            if (qty===0) continue;
            const pdoc = await doc.ref.parent.parent.get();
            let rawName = pdoc.exists ? pdoc.data().name : '—';
            let pname = rawName.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase();
            const btn = document.createElement('button');
            btn.className = 'w-full flex justify-between p-4 bg-white border-l-4 border-primary rounded-lg shadow-lg hover:shadow-xl transition';
            btn.innerHTML = `
              <div>
                <div class="font-semibold">${pname}</div>
                <div class="text-sm text-gray-500">${qty} τεμ.</div>
              </div>
              <div class="font-bold text-primary">€${od.total.toFixed(2)}</div>`;
            btn.onclick = () => openOrderDetail(doc.ref, pname);
            ordersList.appendChild(btn);
          }
          if (!ordersList.children.length) {
            ordersList.innerHTML = '<p class="text-center text-gray-500">Δεν υπάρχουν ενεργές.</p>';
          }
        }, err=>{
          ordersList.innerHTML = `<p class="text-red-500 text-center">Σφάλμα: ${err.message}</p>`;
        });
    }
    function closeLiveOrdersModal(){
      liveOrdersModal.classList.add('opacity-0','pointer-events-none');
    }

    // Executed Orders
    document.getElementById('executedOrdersCard').onclick = openExecutedOrdersModal;
    function openExecutedOrdersModal(){
      executedList.innerHTML = '<p class="text-center text-gray-500">Φόρτωση…</p>';
      executedOrdersModal.classList.remove('opacity-0','pointer-events-none');
      db.collectionGroup('orders')
        .orderBy('timestamp','desc')
        .onSnapshot(async snap=>{
          executedList.innerHTML = '';
          const today = new Date().toDateString();
          for (let doc of snap.docs) {
            const od = doc.data();
            if (!od.executed) continue;
            const ts = od.timestamp?.toDate();
            if (ts && ts.toDateString()!==today) continue;
            const pdoc = await doc.ref.parent.parent.get();
            let rawName = pdoc.exists ? pdoc.data().name : '—';
            let pname = rawName.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase();
            const execAt = od.executedAt ? new Date(od.executedAt.toDate()).toLocaleString() : '—';
            const div = document.createElement('div');
            div.className = 'w-full flex justify-between p-4 bg-gray-50 border-l-4 border-success rounded-lg shadow-inner';
            div.innerHTML = `
              <div>
                <div class="font-semibold">${pname}</div>
                <div class="text-sm text-gray-500">${execAt}</div>
              </div>
              <div class="font-bold text-success">€${od.total.toFixed(2)}</div>`;
            executedList.appendChild(div);
          }
          if (!executedList.children.length) {
            executedList.innerHTML = '<p class="text-center text-gray-500">Δεν υπάρχουν εκτελεσμένες.</p>';
          }
        });
    }
    function closeExecutedOrdersModal(){
      executedOrdersModal.classList.add('opacity-0','pointer-events-none');
    }

    // Order Detail
    function openOrderDetail(ref, pname){
      currentOrderRef = ref;
      detailTitle.textContent = `Παραγγελία @ ${pname}`;
      detailContent.innerHTML = '<p class="text-gray-500">Φόρτωση…</p>';
      orderDetailModal.classList.remove('opacity-0','pointer-events-none');
      ref.get().then(async odoc=>{
        detailContent.innerHTML = '';
        const od = odoc.data();
        const itemsSnap = await ref.collection('items').get();
        for (let it of itemsSnap.docs){
          const itm = it.data();
          const ps = await itm.productId.get();
          let rawProd = ps.exists ? ps.data().name : itm.productId.id;
          let prodName = rawProd.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase();
          const row = document.createElement('div');
          row.className = 'flex justify-between';
          row.innerHTML = `<span>${itm.quantity}× ${prodName}</span><span>€${itm.subtotal.toFixed(2)}</span>`;
          detailContent.appendChild(row);
        }
        const totDiv = document.createElement('div');
        totDiv.className = 'mt-4 flex justify-between font-bold text-lg';
        totDiv.innerHTML = `<span>Σύνολο:</span><span>€${od.total.toFixed(2)}</span>`;
        detailContent.appendChild(totDiv);
        if (od.remarks) {
          const rem = document.createElement('div');
          rem.className = 'mt-2 italic text-gray-600';
          rem.textContent = `Παρατηρήσεις: ${od.remarks}`;
          detailContent.appendChild(rem);
        }
      });
    }
    function closeOrderDetailModal(){
      orderDetailModal.classList.add('opacity-0','pointer-events-none');
    }

    // Εκτέλεση Παραγγελίας
    document.getElementById('executeOrderBtn').onclick = async () => {
      if (!currentOrderRef) return;
      if (!confirm('Εκτέλεση παραγγελίας;')) return;
      await currentOrderRef.update({
        executed: true,
        executedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      closeOrderDetailModal();
      closeLiveOrdersModal();
    };

    // Ακύρωση Παραγγελίας
    document.getElementById('cancelOrderBtn').onclick = async () => {
      if (!currentOrderRef) return;
      if (!confirm('Διαγραφή παραγγελίας;')) return;
      const itemsSnap = await currentOrderRef.collection('items').get();
      for (let it of itemsSnap.docs) await it.ref.delete();
      await currentOrderRef.delete();
      closeOrderDetailModal();
      closeLiveOrdersModal();
    };
  </script>
</body>
</html>
